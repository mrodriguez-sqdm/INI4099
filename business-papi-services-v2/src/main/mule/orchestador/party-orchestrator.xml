<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="get-party-id-orchestratorSub_Flow" doc:id="cb090fff-7bab-4a0d-bc8b-d79471895a96" >
		<set-variable value="#[attributes.uriParams.id]" doc:name="Set Variable" doc:id="05639d91-15c3-43e8-84ca-8b0fcae838e1" variableName="numeroIdentificacion"/>
		<set-variable value="#[attributes.headers]" doc:name="set headers" doc:id="1f6e5091-5088-4b4e-9707-9448b8358ce1" variableName="headers" />
		<flow-ref doc:name="Flow Reference" doc:id="e88f3949-e3f2-4cb0-865b-18acd56de98d" name="get-employee-sapi-clientSub_Flow"/>
		<choice doc:name="Validacion de respuesta de LDAP" doc:id="3562d8e4-8b63-4957-8264-e34e7a3fd372">
			<when expression='#[payload.employee? and (payload.employee != {})]'>
				<choice doc:name="Choice" doc:id="abf565b4-e2f7-48e8-9f60-9fd767dfa93c" >
					<when expression='#[payload.employee.status == "ACTIVO"]'>
						<ee:transform doc:name="Set Payload Response Success" doc:id="f64c1da5-1398-4601-8487-43a49bdc0696">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	id: payload.employee.workforceID,
	fullName: upper(payload.employee.fullName),
	status: upper(payload.employee.status),
    contactMedium: (
    []
    ++ (if (!isEmpty(payload.employee.email)) [{ mediumType: "email", value: payload.employee.email }] else [])
    ++ (if (!isEmpty(payload.employee.telephoneNumber)) [{ mediumType: "mobile", value: payload.employee.telephoneNumber }] else [])
  )
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
					</when>
					<otherwise >
						<ee:transform doc:name="Set Payload Response Fail" doc:id="6b1e1da1-25ab-4029-a408-f44181b55fa8" >
							<ee:message >
								<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  "status": 200,
  "code": "NO_ACTIVE",
  "message": {
    "message": "the employee is not active"
  }
}]]></ee:set-payload>
							</ee:message>
						</ee:transform>
					</otherwise>
				</choice>
			</when>
			<otherwise>
				<flow-ref doc:name="Flow Reference" doc:id="c01228f8-a4e1-4447-a9eb-e3f70d72d314" name="get-employee-ofsc-Sub_Flow" />
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="get-party-orchestratorSub_Flow" doc:id="1d0fdbf1-b4ba-459a-bdeb-34be2f443a0a" >
		<set-variable value="#[attributes.queryParams]" doc:name="Set Params" doc:id="32ea20e1-36d6-4c0d-8f42-873ec2c85edc" variableName="parameters"/>
		<set-variable value="#[attributes.headers]" doc:name="Set headers" doc:id="3a050a6e-c51f-4275-af44-ad339cf5e19e" variableName="headers" />
		<set-variable value="#[[]]" doc:name="Set Variable" doc:id="481da76a-7cb2-47c5-a900-91a0d861edb9" variableName="bodyResponse"/>
		<flow-ref doc:name="Flow Reference" doc:id="6bb40cd9-051c-4eb9-9f1f-a8822686daca" name="get-party-clientSub_Flow"/>
		<choice doc:name="Choice" doc:id="4adba65e-d24b-4197-a14c-60bed2d7af5d" >
			<when expression="#[payload.totalResults &gt; 0]">
				<foreach doc:name="For Each" doc:id="3628c4be-cc4d-4de8-a18e-8366f8ec3f57" collection="#[payload.items]">
					<set-variable value="#[payload.resourceId]" doc:name="Set Id Employee" doc:id="887c3714-3147-48df-bd5d-274abb5e3917" variableName="numeroIdentificacion" />
					<flow-ref doc:name="Flow Reference" doc:id="65169a7c-081a-4d04-a0f4-efc7e7b731f7" name="get-employee-ofsc-Sub_Flow"/>
					<set-variable value="#[%dw 2.0&#10;output application/json&#10;---&#10;if(payload.id != null)(&#10;	(vars.bodyResponse default []) ++ [payload]&#10;)else {}]" doc:name="Set Variable" doc:id="d6d12875-b867-4226-8046-c83fb922d66c" variableName="bodyResponse"/>
				</foreach>
			</when>
			<otherwise >
				<ee:transform doc:name="Set Payload Response Fail" doc:id="1a11d3d4-ef26-41c0-b702-9295c076bdd3">
							<ee:message>
								<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  "status": 200,
  "code": "NO_DATA",
  "message": {
    "message": "No se obtuvieron datos de cuadrillas"
  }
}]]></ee:set-payload>
							</ee:message>
						</ee:transform>
			</otherwise>
		</choice>
		<ee:transform doc:name="Transform Message" doc:id="ee5a0c36-367a-4a7a-b854-f4f8042c721f" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
if(vars.bodyResponse != [])
 vars.bodyResponse
 else
  payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>
	<sub-flow name="get-employee-ofsc-Sub_Flow" doc:id="d88513d2-a2a2-4f15-b83d-e0c026328cbd" >
		<flow-ref doc:name="Flow Reference" doc:id="1543d22e-76b8-4f0a-8b37-78cbdab5bc71" name="get-party-id-clientSub_Flow" />
		<choice doc:name="Validacion de estado Empleado" doc:id="6c173e74-9096-4f20-9f46-09b8dd51b681" >
			<when expression='#[payload.status == "active"]' >
				<ee:transform doc:name="Set Payload Response Success" doc:id="659099a0-86a8-41f7-a844-e023a7b12383" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	id: payload.resourceId,
	fullName: upper(payload.name),
	status: upper(payload.status),
    contactMedium: (
    []
    ++ (if (!isEmpty(payload.email)) [{ mediumType: "email", value: payload.email }] else [])
    ++ (if (!isEmpty(payload.phone)) [{ mediumType: "mobile", value: payload.phone }] else [])
  )
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</when>
			<otherwise>
				<ee:transform doc:name="Set Payload Response Fail" doc:id="d8c80e1f-fa9b-499c-b047-607b5703fc6e" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  "status": 200,
  "code": "NO_ACTIVE",
  "message": {
    "message": "the employee is not active"
  }
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</otherwise>
		</choice>
	</sub-flow>
</mule>
