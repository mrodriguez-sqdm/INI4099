<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="post-invokeETADirectInbound-orchestratorSub_Flow" doc:id="6ccabccc-38ac-4977-9ff9-3daece755dd2" >
		<flow-ref doc:name="Get ShaPass" doc:id="79b84a20-5331-497f-8580-c4ef54bd53a8" name="get-shaPass-orchestrator.xml"/>
		<ee:transform doc:name="Map Request" doc:id="32e794c5-16d6-4773-9421-e9237e1ff2a5" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
ns soapenv http://schemas.xmlsoap.org/soap/envelope/
var inputBody = payload.inbound_interface_request
output application/xml  writeDeclaration = false, encoding = "UTF-8", skipNullOn = "everywhere"
---
 soapenv# Envelope @("xmlns:urn": "urn:toatech:InboundInterface:1.0"): {
    soapenv#Header: null,
    soapenv#Body: {
      "urn:inbound_interface_request" @("xmlns:ns0": "urn:toatech:InboundInterface:1.0"): {
        user: {
          now: vars.shaPass.now,
          login: vars.shaPass.shaLogin,
          company: p('oracle-ocs.company'),
          auth_string: vars.shaPass.shaPass
        },
        "head": {
          processing_mode: inputBody.head.processing_mode,
          upload_type: inputBody.head.upload_type,
          id: inputBody.head.id,
          date: inputBody.head.date,
          allow_change_date: inputBody.head.allow_change_date,
          appointment: inputBody.head.appointment map {
            keys: {
              field: $.keys
            },
            action_if_completed: $.action_if_completed
          },
          inventory: inputBody.head.inventory map {
            keys: {
              field: $.keys
            },
            upload_type: $.upload_type
          },
          properties_mode: inputBody.head.properties_mode,
          provider_group: inputBody.head.provider_group,
          default_appointment_pool: inputBody.head.default_appointment_pool
        },
        data: {
          commands:  {
            command: inputBody.data.commands map {
              date: $.date,
              "type": $."type",
              external_id: $.external_id,
              fallback_external_id: $.fallback_external_id,
              appointmen: $.appointment map {
                appt_number: $.appt_number,
                team_id: $.team_id,
                customer_number: $.customer_number,
                worktype: $.worktype,
                worktype_label: $.worktype_label,
                service_window_start: $.service_window_start,
                service_window_end: $.service_window_end,
                sla_window_start: $.sla_window_start,
                sla_window_end: $.sla_window_end,
                time_of_booking: $.time_of_booking,
                time_slot: $.time_slot,
                duration: $.duration,
                name: $.name,
                message_methods: $.message_methods,
                phone: $.phone,
                email: $.email,
                cell: $.cell,
                address: $.address,
                city: $.city,
                state: $.state,
                zip: $.zip,
                language: $.language,
                reminder_time: $.reminder_time,
                time_zone: $.time_zone,
                coordx: $.coordx,
                coordy: $.coordy,
                points: $.points,
                properties: {
                  property: $.properties map {
                    label: $.label,
                    value: $.value
                  }
                },
                inventories: {
                  inventory: $.inventories map {
                    properties: {
                      property: $.properties map {
                        label: $.label,
                        value: $.value
                      }
                    },
                    files: {
                        file: $.files map {
                            property_label: $.property_label,
                            filename: $.filename,
                            mime_type: $.mime_type,
                            encoding: $.encoding,
                            contents: $.contents
                        }
                    },
                    userdata: $.userdata
                  }
                },
                links: $.links map {
                    erase_links: $.erase_links,
                    link_start_together: $.link_start_together,
                    link_start_after: $.link_start_after,
                    link : $.link
                },
                files: {
                        file: $.files map {
                            property_label: $.property_label,
                            filename: $.filename,
                            mime_type: $.mime_type,
                            encoding: $.encoding,
                            contents: $.contents
                        }
                 },
                provider_preferences: {
                     preference: $.provider_preferences
                },
                required_inventories: {
                    required_inventory: $.required_inventories
                },
                action_if_completed: $.action_if_completed,
                userdata: $.userdata
              },
              inventories: {
                  inventory: $.inventories map {
                    properties: {
                      property: $.properties map {
                        label: $.label,
                        value: $.value
                      }
                    },
                    files: {
                        file: $.files map {
                            property_label: $.property_label,
                            filename: $.filename,
                            mime_type: $.mime_type,
                            encoding: $.encoding,
                            contents: $.contents
                        }
                    },
                    userdata: $.userdata
                  }
              },
              userdata: $.userdata
            }
          },
          providers:  {
            provider: inputBody.data.providers map {
              date: $.date,
              "type": $."type",
              external_id: $.external_id,
              fallback_external_id: $.fallback_external_id,
              appointment: $.appointment map {
                appt_number: $.appt_number,
                team_id: $.team_id,
                customer_number: $.customer_number,
                worktype: $.worktype,
                worktype_label: $.worktype_label,
                service_window_start: $.service_window_start,
                service_window_end: $.service_window_end,
                sla_window_start: $.sla_window_start,
                sla_window_end: $.sla_window_end,
                time_of_booking: $.time_of_booking,
                time_slot: $.time_slot,
                duration: $.duration,
                name: $.name,
                message_methods: $.message_methods,
                phone: $.phone,
                email: $.email,
                cell: $.cell,
                address: $.address,
                city: $.city,
                state: $.state,
                zip: $.zip,
                language: $.language,
                reminder_time: $.reminder_time,
                time_zone: $.time_zone,
                coordx: $.coordx,
                coordy: $.coordy,
                points: $.points,
                properties: {
                  property: $.properties map {
                    label: $.label,
                    value: $.value
                  }
                },
                inventories: {
                  inventory: $.inventories map {
                    properties: {
                      property: $.properties map {
                        label: $.label,
                        value: $.value
                      }
                    },
                    files: {
                        file: $.files map {
                            property_label: $.property_label,
                            filename: $.filename,
                            mime_type: $.mime_type,
                            encoding: $.encoding,
                            contents: $.contents
                        }
                    },
                    userdata: $.userdata
                  }
                },
                links: $.links map {
                    erase_links: $.erase_links,
                    link_start_together: $.link_start_together,
                    link_start_after: $.link_start_after,
                    link : $.link
                },
                files: {
                        file: $.files map {
                            property_label: $.property_label,
                            filename: $.filename,
                            mime_type: $.mime_type,
                            encoding: $.encoding,
                            contents: $.contents
                        }
                 },
                provider_preferences: {
                     preference: $.provider_preferences
                },
                required_inventories: {
                    required_inventory: $.required_inventories
                },
                action_if_completed: $.action_if_completed,
                userdata: $.userdata
              },
              inventories: {
                  inventory: $.inventories map {
                    properties: {
                      property: $.properties map {
                        label: $.label,
                        value: $.value
                      }
                    },
                    files: {
                        file: $.files map {
                            property_label: $.property_label,
                            filename: $.filename,
                            mime_type: $.mime_type,
                            encoding: $.encoding,
                            contents: $.contents
                        }
                    },
                    userdata: $.userdata
                  }
              },
              userdata: $.userdata
            }
          }
        }
      }
    }
  }
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<flow-ref doc:name="Go to client" doc:id="df1c7b42-7fb5-4b1e-a921-5043d38388d1" name="post-cancelOrder-clientSub_Flow"/>
		<ee:transform doc:name="Map Output" doc:id="686ab27e-b188-4f0f-aad2-dc2b41995b3d" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json skipNullOn="everywhere"
var response = payload.Envelope.Body.inbound_interface_response
---
{
	inbound_interface_response: {
		head: {
			trx_id: vars.inputBody.inbound_interface_request.head."trx_id",
			component: "Outbound_INVMOVE",
			id: response.head.id,
			date: response.head.date,
		},
		data: {
			commands: response.data.commands.*command map 
                {
				date: $.date,
				"type": $."type",
				external_id: $.external_id,
				fallback_external_id: $.fallback_external_id,
				appointment: $.*appointment map (obj,ind) -> {
					appt_number: obj.appt_number,
					customer_number: obj.customer_number,
					name: obj.name,
					aid: obj.aid,
					inventories: obj.inventories.*inventory map (o,i) ->
                        {
						properties: o.properties.*property,
						report: o.report.*message,
						userdata: o.userdata,
						invid: o.invid
					},
					report: obj.report.*message,
					userdata: obj.userdata
				},
				inventories: $.inventories.*inventory map (o,i) ->
                    {
					properties: o.properties.*property,
					report: o.report.*message,
					userdata: o.userdata,
					invid: o.invid
				},
				report: $.report.*message,
				userdata: $.userdata
			},
			providers: response.data.providers.*provider map 
                {
				external_id: $.external_id,
				appointment: $.*appointment map (obj,ind) -> {
					appt_number: obj.appt_number,
					customer_number: obj.customer_number,
					name: obj.name,
					aid: obj.aid,
					inventories: obj.inventories.*inventory map (o,i) ->
                        {
						properties: o.properties.*property,
						report: o.report.*message,
						userdata: o.userdata,
						invid: o.invid
					},
					report: obj.report.*message,
					userdata: $.userdata
				},
				inventories: $.inventories.*inventory map (o,i) ->
                    {
					properties: o.properties.*property,
					report: o.report.*message,
					userdata: o.userdata,
					invid: o.invid
				},
				report: $.report.*message,
				userdata: $.userdata
			},
		},
		report: response.report.*message
	}
}
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>
</mule>
