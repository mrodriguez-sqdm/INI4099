<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="post-createOrder-orchestratorSub_Flow" doc:id="c512db4b-562d-4e23-9fc2-14c06dd1a903" >
		<flow-ref doc:name="shaPass" doc:id="bd032733-4ca4-4d39-b5a7-6db9bcd4fb7a" name="get-shaPass-orchestrator.xml"/>
		<ee:transform doc:name="XML body" doc:id="94027c15-0414-4428-894b-a61c2d1b0c46" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/xml writeDeclaration = false, encoding = "UTF-8"
ns soapenv http://schemas.xmlsoap.org/soap/envelope/
var property = {
	(payload.CreateOrderInput.Header.Property map ((item, index) -> {
		(item.name):item.value
	}))
}
---
soapenv#Envelope @("xmlns:urn": "urn:toatech:InboundInterface:1.0"): {
	soapenv#Header: null,
	soapenv#Body: {
		"urn:inbound_interface_request" @("xmlns:ns0": "urn:toatech:InboundInterface:1.0"): {
			"user": {
				"now": vars.shaPass.now,
				"login": p('createOrder.shalogin'),
				"company": p('createOrder.company'),
				"auth_string": vars.shaPass.shaPass
			},
			"head": {
				"processing_mode": p('createOrder.processing_mode'),
				"upload_type": p('createOrder.upload_type'),
				"date": now(),
				"allow_change_date": p('createOrder.allow_change_date'),
				"appointment": {
					"keys": {
						"field": p('createOrder.appointment_keys_field')
					}
				},
				"inventory": {
					"keys": {
						"field": p('createOrder.inventory_keys_field1')
					},
					"upload_type": p('createOrder.inventory_upload_type')
				},
				"properties_mode": p('createOrder.properties_mode')
			},
			"data": {
				"commands": {
					"command": {
						"date": payload.CreateOrderInput.Body.Appointment.date,
						"type": p('createOrder.command_type2'),
						"external_id": payload.CreateOrderInput.Body.Location.zone,
						"appointment": {
							"appt_number": payload.CreateOrderInput.Body.Order.id,
							"customer_number": payload.CreateOrderInput.Body.Customer.id,
							"time_slot": payload.CreateOrderInput.Body.Appointment.timeSlot,
							"name": payload.CreateOrderInput.Body.Customer.name,
							"address": payload.CreateOrderInput.Body.Location.address,
							"cell": payload.CreateOrderInput.Body.Customer.phone,
							"city": payload.CreateOrderInput.Body.Location.city,
							"state": payload.CreateOrderInput.Body.Location.state,
							"coordx": payload.CreateOrderInput.Body.Location.longitude,
							"coordy": payload.CreateOrderInput.Body.Location.latitude,
							"duration": payload.CreateOrderInput.Body.Appointment.duration,
							"properties": {
								"property": {
									"label": "XA_Address_Code",
									"value": payload.CreateOrderInput.Body.Location.addressId
								},
								"property": {
									"label": "XA_Reference",
									"value": payload.CreateOrderInput.Body.Location.address
								},
								"property": {
									"label": "XA_Zone",
									"value": payload.CreateOrderInput.Body.Location.zone
								},
								"property": {
									"label": "XA_Product_Categories",
									"value": payload.CreateOrderInput.Body.Service.name
								},
								"property": {
									"label": "XA_Molecule",
									"value": payload.CreateOrderInput.Body.Location.molecule
								},
								"property": {
									"label": "XA_Contact_Name",
									"value": payload.CreateOrderInput.Body.Contact.name
								},
								"property": {
									"label": "XA_ID",
									"value": payload.CreateOrderInput.Body.Contact.id
								},
								"property": {
									"label": "XA_ID_Type",
									"value": payload.CreateOrderInput.Body.Contact.idType
								},
								"property": {
									"label": "XA_Contact_Phone",
									"value": payload.CreateOrderInput.Body.Contact.phone
								},
								"property": {
									"label": "XA_Cause",
									"value": payload.CreateOrderInput.Body.Order.cause
								},
								"property": {
									"label": "XA_Symptom",
									"value": payload.CreateOrderInput.Body.Order.symptom
								},
								"property": {
									"label": "XA_Description",
									"value": payload.CreateOrderInput.Body.Order.description
								},
								"property": {
									"label": "XA_Technology_Name",
									"value": payload.CreateOrderInput.Body.Service.technology
								},
								"property": {
									"label": "XA_Action_Type",
									"value": payload.CreateOrderInput.Body.Order.actionType
								},
								("property": {
									"label": "XA_POTS_ADSL",
									"value": payload.CreateOrderInput.Body.Service.resources
								}) if (payload.CreateOrderInput.Body.Service.resources != null),
								("property": {
									"label": "XA_UEN",
									"value": payload.CreateOrderInput.Body.Customer.uen
								}) if (payload.CreateOrderInput.Body.Customer.uen != null),
								("property": {
									"label": "XA_Segmento_UEN",
									"value": property.XA_Segmento_UEN
								}) if (property.XA_Segmento_UEN != null),
								("property": {
									"label": "XA_Segmento_Cliente",
									"value": property.XA_Segmento_Cliente
								}) if (property.XA_Segmento_Cliente != null),
								("property": {
									"label": "XA_Categoria_Cliente",
									"value": property.XA_Categoria_Cliente
								}) if (property.XA_Categoria_Cliente != null),
								("property": {
									"label": "XA_Salesforce_Serviceid",
									"value": property.XA_Salesforce_Serviceid
								})if (property.XA_Salesforce_Serviceid != null),
								("property": {
									"label": "XA_ACT_WORKSKILL",
									"value": property.XA_ACT_WORKSKILL
								})if (property.XA_ACT_WORKSKILL != null)
							},
							"worktype_label": payload.CreateOrderInput.Body.Order.workTypeLabel
						}
					}
				}
			}
		}
	}
}
				

            ]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<flow-ref doc:name="Go to client" doc:id="d4c9fa34-3a4b-4a34-b739-a8003d56e884" name="post-cancelOrder-clientSub_Flow" target="response"/>
		<choice doc:name="Choice" doc:id="9ddcbb85-19f6-43ae-b9de-47626e1863a2" >
			<when expression='#[%dw 2.0&#10;output application/java &#10;var appReport = vars.response.Envelope.Body.inbound_interface_response.data.commands.command.appointment.report.*message&#10;var report = vars.response.Envelope.Body.inbound_interface_response.report.*message&#10;---&#10;(appReport.result contains "error") or (report.result contains "error")]'>
				<raise-error doc:name="Raise error" doc:id="bfa86b43-8e39-4874-981a-45958ceef07a" type="CUSTOM:ORDER_FAIL" description='#[%dw 2.0 output application/java var appReport = vars.response.Envelope.Body.inbound_interface_response.data.commands.command.appointment.report.*message var report = vars.response.Envelope.Body.inbound_interface_response.report.*message --- if (appReport != null) (appReport filter ($.result == "error"))[0].description else (report filter ($.result == "error"))[0].description]'/>
			</when>
			<otherwise >
				<ee:transform doc:name="Success" doc:id="0b4a2aa1-ce3d-4ce6-b816-cf91c3136176" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
var appReport = vars.response.Envelope.Body.inbound_interface_response.data.commands.command.appointment.report.*message
---
{
	"code": "SUCCESS",
	"description": (appReport filter ($.result == "success"))[0].description
}


]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</otherwise>
		</choice>
	</sub-flow>
</mule>
