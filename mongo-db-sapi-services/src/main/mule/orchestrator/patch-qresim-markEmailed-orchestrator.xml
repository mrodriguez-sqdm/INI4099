<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:mongo="http://www.mulesoft.org/schema/mule/mongo"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/mongo http://www.mulesoft.org/schema/mule/mongo/current/mule-mongo.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="patch-qresim-markEmailed-orchestratorSub_Flow" doc:id="patch-qresim-markEmailed-orchestrator-subflow" >
		<logger level="INFO" doc:name="Logger - Start Orchestrator" doc:id="patch-qresim-orchestrator-start-logger" 
			message="Iniciando orquestador para actualizar EnvioResponsys - Numero_Orden: #[vars.Numero_Orden], ICCID: #[vars.ICCID]"/>
		
		<flow-ref doc:name="Flow Reference - Client" doc:id="patch-qresim-client-ref" name="patch-qresim-markEmailed-clientSub_Flow"/>
		
		<choice doc:name="Choice - Check Update Result" doc:id="patch-qresim-update-result-choice">
			<when expression="#[payload.modifiedCount &gt; 0 or payload.alreadyMarked]">
				<logger level="INFO" doc:name="Logger - Success Update" doc:id="patch-qresim-success-logger" 
					message="Documento actualizado exitosamente - modifiedCount: #[payload.modifiedCount]"/>
				
				<ee:transform doc:name="Transform Message - Success Response" doc:id="patch-qresim-success-transform">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    "status": 200,
    "message": "Documento actualizado exitosamente",
    "modifiedCount": payload.modifiedCount,
    "data": {
        "Numero_Orden": vars.Numero_Orden,
        "ICCID": vars.ICCID,
        "EnvioResponsys": vars.EnvioResponsys
    }
}]]></ee:set-payload>
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="httpStatus"><![CDATA[200]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
			</when>
			<otherwise>
				<logger level="WARN" doc:name="Logger - No Document Updated" doc:id="patch-qresim-no-update-logger" 
					message="No se encontr칩 documento para actualizar - Numero_Orden: #[vars.Numero_Orden], ICCID: #[vars.ICCID]"/>
				
				<ee:transform doc:name="Transform Message - Not Found Response" doc:id="patch-qresim-notfound-transform">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    "status": 404,
    "code": "NOT_FOUND",
    "message": {
        "message": "Documento no encontrado para actualizar"
    },
    "messageServer": "No se encontr칩 documento con los par치metros proporcionados",
    "cause": [
        {
            "origin": "mongo-db-sapi-services",
            "message": "No se encontr칩 documento con Numero_Orden: " ++ vars.Numero_Orden ++ " e ICCID: " ++ vars.ICCID
        }
    ]
}]]></ee:set-payload>
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="httpStatus">404</ee:set-variable>
					</ee:variables>
				</ee:transform>
			</otherwise>
		</choice>
		
		<logger level="INFO" doc:name="Logger - End Orchestrator" doc:id="patch-qresim-orchestrator-end-logger" 
			message="Finalizando orquestador para actualizar EnvioResponsys"/>
	</sub-flow>
</mule>
