<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:mongo="http://www.mulesoft.org/schema/mule/mongo" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/mongo http://www.mulesoft.org/schema/mule/mongo/current/mule-mongo.xsd">
	<sub-flow name="patch-serviceProblem-pqrs-update-clientFlow" doc:id="a0424925-258d-4e63-aa07-9fb1f38ea5a0" >
		<mongo:update-documents collectionName="${mongoDb-mdm.serviceProblem.collection-pqr}" doc:name="Update documents" doc:id="bc573d48-fc94-45e0-a40d-caffe7f0a33c" config-ref="mdm_db_Config">
					<mongo:query><![CDATA[#[%dw 2.0
output application/json
---
{ 
	numero_pqr: vars.numero_pqr
}]]]></mongo:query>
				</mongo:update-documents>
		<ee:transform doc:name="Transform Message" doc:id="a0cd4c31-1e71-41e1-8c66-52cdb3124b62">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0

var resultCode = if(payload.modified > 0) 'SUCCESS' else "FAIL"
var resultDescription = if(payload.modified > 0) "Order updated" else "error in activity creation"
	
output application/json
---
{
  response: {
    result: {
      code: resultCode,
      description: resultDescription
    },
    responseDate: now(),
    orderNumber: vars.numero_pqr
  }
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
	</sub-flow>
	<sub-flow name="patch-serviceProblem-pqrs-find-clientSub_Flow" doc:id="ebdca0b7-d146-4eb2-84db-b469d5e5abdd" >
		<mongo:find-documents doc:name="Find documents" doc:id="37197495-be0c-4bb8-8ac2-3cacdd336648" config-ref="mdm_db_Config" collectionName="${mongoDb-mdm.serviceProblem.collection-pqr}" fields=",">
			<mongo:query><![CDATA[#[%dw 2.0
output application/json
---
{ 
	numero_pqr: vars.numero_pqr
}]]]></mongo:query>
		</mongo:find-documents>
		<choice doc:name="Choice" doc:id="2cd9595b-dab8-4195-87ac-f344e0bf917e" >
			<when expression='#[!isEmpty(payload[0]."_id"."\$oid")]'>
				<ee:transform doc:name="Transform Message" doc:id="f4d06487-02c4-40f0-84a9-5d214ba788fe" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</when>
			<otherwise >
				<set-payload value="#[null]" doc:name="Set Payload" doc:id="1ea6e593-1db2-4bb1-9fc5-d193551b2c9e" />
			</otherwise>
		</choice>
	</sub-flow>
</mule>
