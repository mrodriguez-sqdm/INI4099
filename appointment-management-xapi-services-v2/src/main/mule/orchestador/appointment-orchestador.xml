<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="appointment-get-orchestadorSub_Flow" doc:id="427b5c2f-e8aa-4d8f-a5a8-519c230c1fff" >
		<set-variable value="#[attributes.queryParams]" doc:name="Save Params Values" doc:id="108eaeac-96f5-4751-9d7c-707ef156ec5b" variableName="parameters"/>
		<set-variable value="#[attributes.headers]" doc:name="Save Headers Values" doc:id="39e54839-4daf-442c-852d-23e7c4d845d3" variableName="headers"/>
		<ee:transform doc:name="Transform FILTROS PARAM to JSON" doc:id="64c20116-c72c-4d12-83c5-75710030eefb" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
var raw = vars.parameters.FILTERS
var lista = raw splitBy ";"
var pares = lista map (item) -> item splitBy ":"
var filtrados = pares filter (kv) -> sizeOf(kv) == 2
var resultado = filtrados reduce (pair, acc = {}) -> acc ++ {
  (pair[0] as String {lowerFirst: true}): pair[1]
}
---
{
  filtros: resultado
}
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<set-variable value='#[%dw 2.0&#10;output application/java&#10;---&#10;if(vars.parameters.CUSTOMER_ID_TYPE != null and vars.parameters.CUSTOMER_ID_TYPE != "" &#10;	and vars.parameters.CUSTOMER_ID != null and vars.parameters.CUSTOMER_ID != ""&#10;)&#10; if(sizeOf((payload.filtros default {}) pluck ((v,k) -&gt; v)) &gt; 0)&#10;  false&#10; else&#10;  true &#10;else&#10;	if(sizeOf((payload.filtros default {}) pluck ((v,k) -&gt; v)) &gt; 0)&#10;	  true&#10;	else&#10;	  false]' doc:name="Set isValidRequestParams" doc:id="f4928e0a-690a-49f5-a52d-88b6dc3ac114" variableName="isValidRequestParams"/>
		<choice doc:name="Choice" doc:id="dbe30739-6710-4037-ad9d-317e85fe4df6" >
			<when expression="#[vars.isValidRequestParams]">
				<flow-ref doc:name="Flow Reference Call mongo-db-sapi-get-pqrAgendaTmr" doc:id="dc3af746-6eb6-4c4b-b6a7-9dc9f37d250a" name="mongo-db-sapi-get-pqrAgendaTmr-clientSub_Flow"/>
				<ee:transform doc:name="Transform Message" doc:id="77d05a1f-bdbf-44c2-b450-5e66b3f1140c" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
    codeResponse: payload.code,
    responseMessage: payload.message,
    appointments: payload.agendas map (item) -> {
        id: item."_id"."\$oid",
        actionType: item.action_type,
        address: item.address,
        tmrSchedules: item.agendas_tmr map (tmr) -> {
            id: tmr."_id"."\$oid",
            scheduleStatus: tmr.estado_agenda,
            creationDate: tmr.fecha_creacion."\$date",
            scheduleStartDate: tmr.fecha_inicio_agenda default [],
            etaId: tmr.id_eta default "",
            requestedByCustomer: tmr.solicitado_cliente,
            timeSlot: tmr.timeslot,
            channel: tmr.canal default "",
            scheduleEndDate: tmr.fecha_fin_agenda,
            osmId: tmr.id_osm default "",
            rescheduleReason: tmr.motivo_reagendamiento default "",
            scheduleOpportunity:
                tmr.oportunidad_agenda match {
                    case arr is Array -> arr
                    else -> [tmr.oportunidad_agenda]
                },
            createdByUser: tmr.usuario_creador,
            modifiedByUser: tmr.usuario_modificador
        },
        connectionNumber: item.connection_number,
        cun: item.cun,
        customerDocumentNumber: item.customer_document_number,
        customerDocumentType: item.customer_document_type,
        duration: item.duration,
        updateDate: item.fecha_actualizacion."\$date",
        orderNumber: item.order_number,
        orderType: item.order_type,
        originSystem: item.origin_system,
        serviceType: item.service_type,
        skill: item.skill,
        technicianDocumentNumber: item.technician_document_number,
        technicianDocumentType: item.technician_document_type,
        technology: item.technology,
        createdBy: item.usuario_creo,
        zone: item.zone
    }
}
]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</when>
			<otherwise>
				<ee:transform doc:name="Transform Message" doc:id="fa051fbd-681f-4c58-8e40-87d438598b08" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  "status": 400,
  "code": "BAD REQUEST",
  "message": {
    "message": "Error processing your consultation request"
  }
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<set-variable value="400" doc:name="Set Variable" doc:id="20792db7-5d58-47e9-bc28-2bd82172ea2a" variableName="httpStatus"/>
			</otherwise>
		</choice>
	</sub-flow>
</mule>
