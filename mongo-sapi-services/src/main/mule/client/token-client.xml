<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:mongo="http://www.mulesoft.org/schema/mule/mongo"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/mongo http://www.mulesoft.org/schema/mule/mongo/current/mule-mongo.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="get-token-clientSub_Flow" doc:id="3798a068-de24-48de-8fbd-516918a9de7b" >
		<mongo:find-documents doc:name="Obtener Token" doc:id="b6868612-0edc-4ed6-a65d-279e943412e5" collectionName="${mvne-db.collection-token}" fields="," config-ref="mvne_db_Config"/>
		<logger level="INFO" doc:name="Logger" doc:id="49972b84-1882-4fc6-87e7-364343bb86d7" message="#[output application/json&#10;---&#10;payload[0]]"/>
	</sub-flow>
	<sub-flow name="post-token-clientSub_Flow" doc:id="90e4e494-d549-4d30-bea2-eab9d7ab1b63" >
		<mongo:find-documents doc:name="Buscar token" doc:id="d226f801-8de8-48a1-bd6f-83f31904ebe1" collectionName="${mvne-db.collection-token}" fields=',' config-ref="mvne_db_Config">
		</mongo:find-documents>
				<logger level="INFO" doc:name="Logger" doc:id="53f7fdfe-770a-4ef0-9674-d30246a7598b" message='#[output application/json&#10;---&#10;"Token almacenados: " : sizeOf(payload)]'/>
		<choice doc:name="Choice" doc:id="81448b5e-4a7f-429a-ae4b-84bdfa4d90a2" >
			<when expression="#[sizeOf(payload) &gt; 0]">
				<mongo:remove-documents doc:name="Eliminar token" doc:id="7b05a619-e71a-41a7-b303-014e4b40357e" config-ref="mvne_db_Config" collectionName="${mvne-db.collection-token}"/>
				<logger level="INFO" doc:name="Logger" doc:id="c895c5e1-6ce8-44dc-b7e2-8c426002f3f4" message='#[output application/json&#10;---&#10;"Se elimino el token anterior"]'/>
			
</when>
		</choice>
		<mongo:insert-document collectionName="${mvne-db.collection-token}" doc:name="Registrar token" doc:id="dc351466-dd19-4ab8-ac70-8236abe32756" config-ref="mvne_db_Config">
					<mongo:document><![CDATA[#[vars.initialPayload]]]></mongo:document>
				</mongo:insert-document>
		<logger level="INFO" doc:name="Logger" doc:id="fd3eea49-2ccc-47d3-85fd-6020929cc0e7" message='#[output application/json&#10;---&#10;"Nuevo Token: " : payload]'/>
	</sub-flow>
</mule>
