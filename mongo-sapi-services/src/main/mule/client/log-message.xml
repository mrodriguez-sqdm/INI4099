<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:mongo="http://www.mulesoft.org/schema/mule/mongo"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/mongo http://www.mulesoft.org/schema/mule/mongo/current/mule-mongo.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="log-message-getSubFlow" doc:id="1dc91664-b861-4bf0-b894-d8b66e947e1b" >
		<async doc:name="Async" doc:id="67b3b32d-d7c3-4bb2-a105-d109190bcd3c" >
			<flow-ref doc:name="Call logger before" doc:id="b1455a9f-3497-4919-84af-a5e11c58007c" name="loggin-client-call"/>
		</async>
		<mongo:find-documents doc:name="Find documents" doc:id="566614b3-9821-4deb-a72e-9c9f1b2c2e34" config-ref="mongo-db-imei" collectionName="#[p('mongoDb.collectionLogMessages')]" fields='#[vars.fields]'>
			<mongo:query><![CDATA[#[output application/json
---
{ 
    "mensajeId": vars.id
}]]]></mongo:query>
		</mongo:find-documents>
		<choice doc:name="Choice" doc:id="6d41b739-55a4-44f1-bfa6-48a67b109bbf" >
			<when expression="#[payload is Array and sizeOf(payload) == 0]">
				<raise-error doc:name="Not Found" doc:id="b9943af9-107a-4ba1-9a1a-fbcd6f0b6fa8" type="API:NOT_FOUND" description="Registro no encontrado, revisar ID"/>
			</when>
			<otherwise >
				<ee:transform doc:name="Transform Message" doc:id="d95fda55-dbb7-4922-a61c-e286c6e91677" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</otherwise>
		</choice>
		<async doc:name="Async" doc:id="c44def91-0310-4512-8cb0-9964a79043a8" >
			<flow-ref doc:name="Call logger after" doc:id="01ece13f-474c-4fd9-84e7-7b36e2ecc980" name="loggin-client-call"/>
		</async>
	</sub-flow>
	<sub-flow name="log-message-postSubFlow" doc:id="5d2def0f-5e29-4fa8-ba29-e8cb523fccea" >
		<async doc:name="Async" doc:id="27bac00e-0806-4ece-9d24-e0d04e9891ce" >
			<flow-ref doc:name="Call logger before" doc:id="987cb57e-52b8-4143-841a-3733cbe6b87d" name="loggin-client-call"/>
		</async>
		<mongo:insert-documents doc:name="Insert documents" doc:id="e7b0926b-56cd-4763-9c10-4655a45b576a" config-ref="mongo-db-imei" collectionName="#[p('mongoDb.collectionLogMessages')]"/>
		<ee:transform doc:name="set response" doc:id="f30cd575-491a-4085-bed7-c4eaf3de6a91" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
var successfulItems = if(isEmpty(payload) or isEmpty(payload.items)) [] else payload.items filter (item) -> item.successful
var failedItems = if(isEmpty(payload) or isEmpty(payload.items)) [] else payload.items filter (item) -> not item.successful
var totalItems = if(isEmpty(payload) or isEmpty(payload.items)) 0 else sizeOf(payload.items)
var successfulCount = sizeOf(successfulItems)
var failedCount = sizeOf(failedItems)
---
if(isEmpty(payload) or isEmpty(payload.items))
{
  "status": 500,
  "code": "ALL_FAILED",
  "message": {
    "message": "All records failed to insert"
  },
  "messageServer": "mongo-mvne",
  "cause": [
    {
      "origin": "mongo-mvne",
      "message": "error inserting records, validate database status"
    }
  ],
  "results": []
}
else if(successfulCount == 0)
{
  "status": 500,
  "code": "ALL_FAILED",
  "message": {
    "message": "All records failed to insert"
  },
  "messageServer": "mongo-mvne",
  "cause": [
    {
      "origin": "mongo-mvne",
      "message": "All insertions failed"
    }
  ],
  "results": []
}
else if(failedCount == 0)
{
  "status": 200,
  "code": "ALL_INSERTED",
  "message": {
    "message": "All records inserted successfully"
  },
  "messageServer": "mongo-mvne",
  "insertedCount": successfulCount,
  "results": successfulItems map (item, index) -> {
    "messageId": item.payload.messageId,
    "mongoId": item.payload."_id",
    "status": "success"
  }
}
else
{
  "status": 207,
  "code": "PARTIAL_INSERTED",
  "message": {
    "message": "Some records were inserted successfully, others failed"
  },
  "messageServer": "mongo-mvne",
  "insertedCount": successfulCount,
  "totalAttempted": totalItems,
  "failedCount": failedCount,
  "results": successfulItems map (item, index) -> {
    "messageId": item.payload.messageId,
    "mongoId": item.payload."_id",
    "status": "success"
  }
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<async doc:name="Async" doc:id="f7579fc9-08e6-4262-8e20-15c0b42fb42d" >
			<flow-ref doc:name="Call logger after" doc:id="95a5f702-1b91-43f8-974d-50a62c6eec6b" name="loggin-client-call"/>
		</async>
	</sub-flow>
	<sub-flow name="log-message-patchSubFlow" doc:id="02b0e81e-0eab-4bed-a15d-c056408981b0" >
		<async doc:name="Async" doc:id="39e0f1d7-a314-4f49-86f3-2db71eb7669a" >
			<flow-ref doc:name="Call logger before" doc:id="440c071f-415b-446f-b374-b7affeaed40c" name="loggin-client-call"/>
		</async>
		<mongo:update-documents doc:name="Update documents" doc:id="84489fb6-6191-4dde-9e7c-4a7b477b0c9a" config-ref="mongo-db-imei" collectionName="#[p('mongoDb.collectionLogMessages')]" >
			<mongo:query ><![CDATA[#[output application/json 
--- 
{ 
	"mensajeId": vars.id 
}]]]></mongo:query>
			<mongo:content-to-update ><![CDATA[#[%dw 2.0
output application/json

var prev      = (payload.historialEstados default []) as Array
var prevFlat  = flatten(prev)
var baseFails = sizeOf(prevFlat filter ((it) -> (it.codigoEstado default "") == "MSG_FAILED_SEND"))

var entry = (vars.PayloadMessage default null)

var newItems =
  if (entry == null) []
  else if (entry is Array)
    ((entry as Array) map (e, i) ->
      if ((e.codigoEstado default "") == "MSG_FAILED_SEND")
        (e as Object) ++ {
          reintentos: baseFails + sizeOf(((entry as Array)[0 to i]) filter ((x) -> (x.codigoEstado default "") == "MSG_FAILED_SEND"))
        }
      else e
    )
  else
    [ 
      if (((entry as Object).codigoEstado default "") == "MSG_FAILED_SEND")
        ((entry as Object) ++ { reintentos: baseFails + 1 })
      else
        (entry as Object)
    ]

---
{
  historialEstados: prevFlat ++ newItems
}]]]></mongo:content-to-update>
		</mongo:update-documents>
		<ee:transform doc:name="set response" doc:id="6ad5e2fd-0d37-4661-9348-ac1517c771af" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
if(isEmpty(payload))
{
  "status": 400,
  "code": "NOT_UPDATED",
  "message": {
    "message": "There is a problem when record is updated"
  },
  "messageServer": "",
  "cause": [
    {
      "origin": 'mongo-mvne',
      "message": "Error updating records"
    }
  ]
}
else
	payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<async doc:name="Async" doc:id="7b220949-5312-4a92-8fd0-0f1275987fb1" >
			<flow-ref doc:name="Call logger after" doc:id="650c7d52-acbc-4791-93bb-458f27316a4d" name="loggin-client-call"/>
		</async>
	</sub-flow>
	<sub-flow name="log-message-sent-patchSubFlow" doc:id="8163191d-83ae-4322-9a97-322d09e828aa" >
		<async doc:name="Async" doc:id="4d6f340f-814e-4ce3-b37d-fb21973bf0f7" >
			<flow-ref doc:name="Call logger before" doc:id="70bd47ad-bee3-4eaf-b9f8-655a5f3acc1c" name="loggin-client-call"/>
		</async>
		<mongo:update-documents doc:name="Update documents" doc:id="6b35c48d-9f61-4ae8-a1c6-71aff4844562" config-ref="mongo-db-imei" collectionName="#[p('mongoDb.collectionLogMessages')]">
			<mongo:query ><![CDATA[#[output application/json 
--- 
{ 
	"mensajeId": vars.id
}]]]></mongo:query>
			<mongo:content-to-update ><![CDATA[#[%dw 2.0
output application/json
---
{
  smscId: vars.PayloadMessage.smscId,
  respuestaSMSC: vars.PayloadMessage.respuestaSMSC,
  fechaRespuesta: vars.PayloadMessage.fechaRespuesta,
  metadata: ((vars.PayloadMessage.metadata default {}) as Object) ++ ((vars.PayloadMessage.metadata default {}) as Object)
}]]]></mongo:content-to-update>
		</mongo:update-documents>
		<ee:transform doc:name="set response" doc:id="d93af525-8ea9-480d-a7b4-23b205daebd8" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
if(isEmpty(payload))
{
  "status": 400,
  "code": "NOT_UPDATED",
  "message": {
    "message": "There is a problem when record is updated"
  },
  "messageServer": "",
  "cause": [
    {
      "origin": 'mongo-mvne',
      "message": "Error updating records"
    }
  ]
}
else
	payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<async doc:name="Async" doc:id="8fd72e5e-9566-4f8b-bd4a-e3afa6ef30fd" >
			<flow-ref doc:name="Call logger after" doc:id="f4707ccf-bf5a-47ae-a499-75d175d780e4" name="loggin-client-call"/>
		</async>
	</sub-flow>
</mule>
