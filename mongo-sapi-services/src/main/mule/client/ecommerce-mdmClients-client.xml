<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:mongo="http://www.mulesoft.org/schema/mule/mongo"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/mongo http://www.mulesoft.org/schema/mule/mongo/current/mule-mongo.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="getClient-clientSub_Flow" doc:id="c05fb714-ab31-48b5-a8a1-fd19aeead93e" >
		<choice doc:name="Choice" doc:id="2c854150-0603-4103-9ea5-7d542290f8b9">
				<when expression='#[vars.logs == "mongo"]'>
				<async doc:name="Async" doc:id="e619eaf7-829e-4e70-acaf-9622b2134b9e" >
					<flow-ref doc:name="Call logger before audits-mongo" doc:id="604e27c8-cfec-49a5-a3e7-2ca43c224dd0" name="audits-mongo-log-before" />
				</async>
				<mongo:find-documents collectionName="${mongoDb-mdm.ecommerce.collection-client}" fields="," doc:name="Find documents" doc:id="97917922-6c43-4f2d-8651-566d46d01175" config-ref="mdm_db_Config">
					<mongo:query><![CDATA[#["{ 'Tipo_Documento': '" ++ attributes.queryParams.'tipoDocumento' ++ "' , 'Numero_Identificacion': '" ++ attributes.queryParams.'numeroIdentificacion' ++ "'}"]]]></mongo:query>
				</mongo:find-documents>
				<async doc:name="Async" doc:id="8aee7832-b2f3-4753-824a-bfe51c9a6e1b" >
					<flow-ref doc:name="Call logger after audits-mongo" doc:id="a18ccd6c-ac3b-4b5d-857c-c65bd47ffce5" name="audits-mongo-log-after" />
				</async>
			</when>
			<otherwise >
				<async doc:name="Async" doc:id="3aca02bc-5859-4db2-b8da-441ec68aa205">
			<flow-ref doc:name="Call logger before" doc:id="e55d37ba-4ffa-428b-aa8e-e0400738af89" name="loggin-client-call" />
		</async>
		<mongo:find-documents doc:name="Find documents" doc:id="8697e5ac-e29c-407b-bf97-ee45d084271e" collectionName="${mongoDb-mdm.ecommerce.collection-client}" fields="," config-ref="mdm_db_Config">
			<mongo:query ><![CDATA[#["{ 'Tipo_Documento': '" ++ attributes.queryParams.'tipoDocumento' ++ "' , 'Numero_Identificacion': '" ++ attributes.queryParams.'numeroIdentificacion' ++ "'}"]]]></mongo:query>
		</mongo:find-documents>
		<async doc:name="Async" doc:id="17c6b456-05f7-4ecb-bc01-6b5035290a62" >
			<flow-ref doc:name="Call logger after" doc:id="7bb40b63-d220-4dfb-8174-768279b53cd7" name="loggin-client-call"/>
		</async>
			</otherwise>
			</choice>
		<ee:transform doc:name="Set Output" doc:id="704c927b-4593-4a20-9a76-eae96668c6d7" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>
	<sub-flow name="createClient-clientSub_Flow" doc:id="49bbed90-ae2a-4edc-b8ab-5eb4c7de80ae" >
		<choice doc:name="Choice" doc:id="5593a0f2-d605-4a6e-8412-8e3883bc9a4a">
			<when expression='#[vars.logs == "mongo"]'>
				<async doc:name="Async" doc:id="85d0f36d-e9b5-481c-8466-32227b4e640f">
					<flow-ref doc:name="Call logger before audits-mongo" doc:id="29771a8c-a8f8-42a5-ad0e-4b2f1e8c237e" name="audits-mongo-log-before" />
				</async>
			</when>
			<otherwise>
				<async doc:name="Async" doc:id="50a68bc7-efed-4860-8289-08a4ae57f077">
					<flow-ref doc:name="Call logger before" doc:id="c0cdb1d4-e250-4793-a019-82ff9bc5d84c" name="loggin-client-call" />
				</async>
			</otherwise>
		</choice>
		<mongo:insert-document doc:name="Insert document" doc:id="198805ad-4bf6-433a-a1cc-8efc95c1de08" collectionName="${mongoDb-mdm.ecommerce.collection-users}" config-ref="mdm_db_Config"/>
		<ee:transform doc:name="Set Output" doc:id="e1362dab-20e5-4a80-8458-298bd59e1407" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<choice doc:name="Choice" doc:id="b5252c5b-f80a-4959-bc97-cc819d0d0cb4" >
			<when expression='#[vars.logs == "mongo"]' >
				<async doc:name="Async" doc:id="8f2e1ab4-66e1-4a72-afb7-544ffe486391" >
					<flow-ref doc:name="Call logger after audits-mongo" doc:id="73a31a09-4ffa-4ca8-b328-8f5f59b16447" name="audits-mongo-log-after" />
				</async>
			</when>
			<otherwise >
				<async doc:name="Async" doc:id="f5002fa9-e2e6-4bbc-8773-f091c7181cd4" >
					<flow-ref doc:name="Call logger after" doc:id="719419d3-e290-4fa2-8a7d-134b3c4627c9" name="loggin-client-call" />
				</async>
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="getClientByEmail-clientSub_Flow" doc:id="4268ad9b-7519-4fe9-a5a8-22833e46c1bd" >
		<choice doc:name="Choice" doc:id="bbe4c93a-719f-4a05-bb89-3bb2c849c32f" >
			<when expression='#[upper(vars.name) == upper("Autogestion")]'>
				<choice doc:name="Choice" doc:id="759023e4-f388-4729-893a-847fd8252f1c">
					<when expression='#[vars.logs == "mongo"]'>
						<async doc:name="Async" doc:id="67049580-ea64-44c5-9daf-7358f9365db1">
							<flow-ref doc:name="Call logger before audits-mongo" doc:id="b6464c7a-8a2c-4b52-a9a4-99f0337798ca" name="audits-mongo-log-before" />
						</async>
					</when>
					<otherwise>
						<async doc:name="Async" doc:id="868f649b-a91f-4c45-a46b-7032025a1bdc">
							<flow-ref doc:name="Call logger before" doc:id="80590dba-022e-4443-aaba-60ea224ab04d" name="loggin-client-call" />
						</async>
					</otherwise>
				</choice>
				<mongo:find-documents collectionName="${mongoDb-mdm.ecommerce.collection-users}" fields="," doc:name="Find documents" doc:id="61017732-0c86-4106-ab66-cdbdd204ae5b" config-ref="mdm_db_Config" >
					<mongo:query ><![CDATA[#[%dw 2.0
output application/json
---
{ 
	Mail: vars.email
}]]]></mongo:query>
				</mongo:find-documents>
				<ee:transform doc:name="Set Output" doc:id="411668ff-f8cc-4e90-a3df-293939bfd86e" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<choice doc:name="Choice" doc:id="a8853e44-56cb-4dd6-9504-93903cdc35a8" >
					<when expression='#[vars.logs == "mongo"]' >
						<async doc:name="Async" doc:id="3fbfe3cd-23d4-49ad-a3cf-a5927ab552b4" >
							<flow-ref doc:name="Call logger after audits-mongo" doc:id="ef8e3944-c105-4e95-9658-ec1351126da2" name="audits-mongo-log-after" />
						</async>
					</when>
					<otherwise >
						<async doc:name="Async" doc:id="b48e4ed2-bf91-4671-aa24-d6d734ab2701" >
							<flow-ref doc:name="Call logger after" doc:id="627c13aa-c817-4900-9cf8-fd01b56a8b03" name="loggin-client-call" />
						</async>
					</otherwise>
				</choice>
			</when>
			<when expression='#[upper(vars.name) == upper("MiEtb-ConsultarUsuario")]'>
				<async doc:name="Async" doc:id="b081413d-8108-453e-847f-4026b139d609" >
					<flow-ref doc:name="Call logger before audits-mongo" doc:id="d3859868-2e9f-4a68-9795-3c2e61fc8b94" name="audits-mongo-log-before" />
				</async>
				<mongo:find-documents collectionName="${mongoDb-mdm.ecommerce.collection-users}" fields="," doc:name="Find documents MiETB" doc:id="fec0909b-b9e4-45c5-8e2e-aff5d1859cf7" config-ref="mdm_db_Config">
					<mongo:query><![CDATA[#[%dw 2.0
output application/json
---
{ 
	Mail: vars.email
}]]]></mongo:query>
				</mongo:find-documents>
				<ee:transform doc:name="Set Output" doc:id="60ba17eb-ded4-4096-b62e-5df4593e823d">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
import * from dw::core::Arrays
---
if(!isEmpty(payload))
{
    accesos: (take((payload[0].Accesos orderBy ($.Fecha_Ultimo_Acceso as LocalDateTime {format: "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'"}) )[-1 to 0],6) 
	    		map {
	                canal: $.Canal,
	                sistema: $.Sistema
	            }) default [],
    estado: payload[0].Estado,
    fechaActivacion: payload[0].FechaActivacion,
    numeroDocumento: payload[0].NumIdentificacion,
    tipoDocumento: payload[0].TipoIdentificacion
}
else []]]></ee:set-payload>
			</ee:message>
		</ee:transform>
				<async doc:name="Async" doc:id="74acca7e-8868-4022-8347-55fd9f27ccac" >
					<flow-ref doc:name="Call logger after audits-mongo" doc:id="b35d71b0-f943-4bb6-ba52-709e0e50c3f5" name="audits-mongo-log-after" />
				</async>
			</when>
			<otherwise >
				<async doc:name="Async" doc:id="9d9e5b6d-e208-4728-8ef3-a5f59579cc31" >
					<flow-ref doc:name="Call logger before" doc:id="067429f6-b0a6-4692-8880-7f2d547ff51b" name="loggin-client-call" />
				</async>
				<mongo:find-documents collectionName="${mongoDb-mdm.ecommerce.collection-users}" fields="," doc:name="Find documents" doc:id="e2ffe89c-96fc-4903-9bc3-6e14337df07a" config-ref="mdm_db_Config">
			<mongo:query><![CDATA[#[%dw 2.0
output application/json
---
{ 
	Mail: vars.email,
	NumIdentificacion: vars.NumIdentificacion,
	TipoIdentificacion: vars.TipoIdentificacion
}]]]></mongo:query>
		</mongo:find-documents>
				<async doc:name="Async" doc:id="5c316c44-7d04-4abd-a1fa-2bec28b96374" >
					<flow-ref doc:name="Call logger after" doc:id="7be20763-0a60-4404-9cad-6cfd80bca90a" name="loggin-client-call" />
				</async>
				<ee:transform doc:name="Set Output" doc:id="03606cf1-dc39-4514-a3a6-30f6ec245be6" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</otherwise>
		</choice>
	</sub-flow>
</mule>
