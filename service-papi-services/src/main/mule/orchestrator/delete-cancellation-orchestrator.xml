<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="delete-cancellation-orchestratorSub_Flow" doc:id="5c61cde1-4c52-4dc9-8c6f-bdb15d67c24d" >
		<try doc:name="Try" doc:id="c2834fc1-0d44-481e-af81-5915a4862fd3">
					<flow-ref doc:name="get-subscription-client" doc:id="245208ed-11d9-4037-bed0-82a514fd2acc" name="get-subscription-client-by-msisdn" />
			<choice doc:name="Choice" doc:id="78b74e85-c6fb-4c73-8d4d-0a793a0ba25d">
			<when expression="#[!isEmpty(payload.content)]">
				<set-variable value="#[payload.content.id[0]]" doc:name="subscription_id" doc:id="3c021c71-16c0-4e39-bd4e-e45e87663c6d" variableName="subscription_id" />
				<set-variable value="payload.content[0].msisdn.id" doc:name="Set msisdn" doc:id="ba6f4846-8bce-4057-bc99-946308109287" variableName="msisdn" />
				<ee:transform doc:name="Payload" doc:id="c11a3339-670d-487a-acfc-0019f57339dd">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	"status": p('subscriberCancel.actionTerminate') // Not used payload, only for pass raml validation.
}

]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<flow-ref doc:name="terminate subscriptionID" doc:id="8f095386-a8f9-41a2-a2e1-eb7fc455be19" name="terminate-subscription-client" />
				<try doc:name="Try" doc:id="5f39c7ef-df16-44e8-bab3-97ca4b5f2002" >
						<ee:transform doc:name="Set request" doc:id="e173be4d-34be-47b1-9332-57a714bedf22">
								<ee:message>
									<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  status: "FREE"
}]]></ee:set-payload>
								</ee:message>
								<ee:variables>
									<ee:set-variable variableName="request"><![CDATA[%dw 2.0
output application/java
import p from Mule
---
{
	msisdn: vars.msisdn,
	action: p('jsc-sapi.msisdn.actionUpdateStatus')
}]]></ee:set-variable>
								</ee:variables>
							</ee:transform>
						<flow-ref doc:name="Go to patch-msisdn-status-client" doc:id="bc84db4e-1278-43d7-b0eb-ea790efb7747" name="patch-msisdn-status-client" />
						<error-handler >
							<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="0a02b854-d35c-49b0-b5db-bfdac61977a7" />
						</error-handler>
					</try>
					<ee:transform doc:name="Successful" doc:id="fec757bb-697e-418c-81d4-d9540df82afe">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	"codigo": "OK",
	"description": "CancelaciÃ³n exitosa."
}]]></ee:set-payload>
					</ee:message>
					<ee:variables>
					</ee:variables>
				</ee:transform>
			</when>
			<otherwise>
				<ee:transform doc:name="Error Output" doc:id="7bc0f80f-bf87-49c5-9fff-a14fced47fbd">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	"status": 404,
	"code": "NOT_FOUND",
	"message": {
		"message": "Data not found"
	},
	"messageServer": "",
	"cause": [{
		"origin": app.name,
		"message": "org.mule.extension.http.api.request.validator.ResponseValidatorTypedException"
	}]
}]]></ee:set-payload>
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="httpStatus"><![CDATA[%dw 2.0
output application/java
---
404]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
			</otherwise>
		</choice>
			<error-handler>
				<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="b4a740cb-542a-4cc1-9a31-273b2ed558d0" >
					<ee:transform doc:name="Error output" doc:id="12997a94-a12a-4196-8f96-0250bbc50f98" >
						<ee:message >
							<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	"status": 500,
	"code": "",
	"message": {
	  "message": (vars.errorMessageOutput default "") ++ " Respuesta JSC: " ++ error.muleMessage.typedValue.message.message default ""
	},
	"messageServer": "",
	"cause": [
	  {
	    "origin": app.name,
	    "message": "org.mule.extension.http.api.request.validator.ResponseValidatorTypedException"
	  }
	]
}]]></ee:set-payload>
						</ee:message>
						<ee:variables >
							<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/java
---
500]]></ee:set-variable>
						</ee:variables>
					</ee:transform>
				</on-error-continue>
					</error-handler>
				</try>
	</sub-flow>
</mule>
