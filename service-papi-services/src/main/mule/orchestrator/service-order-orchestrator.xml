<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="service-order-orchestratorSub_Flow" doc:id="fb825da7-a9af-4c3e-a9c6-bd42c4d40194" >
		<choice doc:name="Choice" doc:id="a715738f-b256-4f56-9a53-2361243ef52b" >
			<when expression='#[upper(payload.serviceOrder.orderType) == "RECONEXION"]'>
				<flow-ref doc:name="Flow Reference" doc:id="302103f2-678a-48a4-87ec-bbd04c655d71" name="post-reconexion-orchestratorSub_Flow"/>
			</when>
			<when expression='#[upper(payload.serviceOrder.orderType) == "TRASLADO"]'>
				<flow-ref doc:name="Flow Reference" doc:id="eee64e5d-51a2-496d-8e2b-ee214a02d68a" name="post-relocate-orchestratorSub_Flow"/>
			</when>
			<when expression='#[upper(payload.serviceOrder.orderType) == "SUSPENSION"]'>
				<flow-ref doc:name="Flow Reference" doc:id="e0aa83b3-517e-43ce-a03f-be549cb15903" name="validate-suspension-orchestratorSub_Flow"/>
			</when>
			<otherwise >
				<set-variable value='#[500]' doc:name="Set Http Status1" doc:id="96308fc6-c5f4-4346-bfd5-c89fded2e300" variableName="httpStatus" />
				<ee:transform doc:name="Set Body Response1" doc:id="8b830410-216a-4624-8a64-991ddc6f3423">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	codeResponse: vars.httpStatus as String ,
	messageResponse: "Ruta no definida segun el campo orderType, valores permitidos RECONEXION,TRASLADO, SUSPENSION"
	
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="validate-suspension-orchestratorSub_Flow" doc:id="381d5cdd-15bd-40e7-8231-19d44f03c8e4" >
		<choice doc:name="Choice" doc:id="fc5a5cc4-c4ef-4f1b-95c8-b8c504b434fa" >
			<when expression='#[upper(payload.serviceOrder.causal) == "VOLUNTARIA"]'>
				<flow-ref doc:name="Flow Reference" doc:id="1c656be2-deed-4e57-914c-d6db5a87861c" name="post-suspendvoluntarily-orchestratorSub_Flow"/>
			</when>
			<when expression='#[upper(payload.serviceOrder.causal) == "ROBO"]'>
				<flow-ref doc:name="Flow Reference" doc:id="9442283d-dfff-407f-acd5-e7ed7f1e733f" name="post-suspendbytheft-orchestratorSub_Flow"/>
			</when>
			<when expression='#[upper(payload.serviceOrder.causal) == "PERDIDA"]'>
				<flow-ref doc:name="Flow Reference" doc:id="f9d09a2c-c3bb-4381-b03d-59db2ef87229" name="post-suspendbyloss-orchestratorSub_Flow"/>
			</when>
			<otherwise >
				<set-variable value='#[500]' doc:name="Set Http Status1" doc:id="093254bc-f488-4a3e-b261-5d73f413d56a" variableName="httpStatus" />
				<ee:transform doc:name="Set Body Response1" doc:id="70ed2800-947d-4e03-9750-0ddef69fd431">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	codeResponse: vars.httpStatus as String ,
	messageResponse: "Ruta no definida segun el campo causal, valores permitidos ROBO, VOLUNTARIA, PERDIDA"
	
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="get-service-order-orchestratorSub_Flow" doc:id="69503731-3fd5-4491-9c40-e290a965105d" >
		<set-variable value="#[attributes.headers]" doc:name="Set Variable" doc:id="c777f918-ae9d-492b-8b06-22c204d76d32" variableName="headers" />
		<set-variable value="#[attributes.queryParams]" doc:name="Set Paremeters" doc:id="c1861e89-16e5-45e9-9092-fea1c43056d3" variableName="parameters" />
		<ee:transform doc:name="Transform FILTROS PARAM to JSON" doc:id="58a9bfcc-a382-4cc2-ac9b-8b2bd3b5c786">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
var raw = vars.parameters.FILTERS
var lista = raw splitBy ";"
var pares = lista map (item) -> item splitBy ":"
var filtrados = pares filter (kv) -> sizeOf(kv) == 2
var resultado = filtrados reduce (pair, acc = {}) -> acc ++ {
  (pair[0] as String {lowerFirst: true}): pair[1]
}
---
{
  filtros: resultado
}
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<ee:transform doc:name="Set Body Request" doc:id="bb18046e-9bc3-4e9f-b346-bdf52229b618" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  "WSRequestHeader": {
    "System": {
      "name": vars.headers.name,
      "correlationID": vars.headers."X-CORRELATION-ID",
      "processingServer": ""
    },
    "Property": []
  },
  "WSRequestBody": {
    "Audit": {
      "Canal": vars.headers.name
    },
    "Filter": {
      "Billing_Account": true,
      "Contracted_Offer": true
    },
    "Phone": payload.filtros.ConecctionNumber default ""
  }
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<flow-ref doc:name="Flow Reference" doc:id="20fafde4-844e-4f81-87de-45c02417b507" name="post-services-get-clientSub_Flow" />
		<set-variable value='#[if(payload.WSResponseHeader.Service.status == "FAIL" and payload.WSResponseHeader.Service.statusDetail[0].errorCode == "BOTERROR")&#10; 500&#10;else&#10; 200]' doc:name="Set Http Status" doc:id="d3684179-434a-42ed-b8d9-237354b4c8b7" variableName="httpStatus" />
		<ee:transform doc:name="Set Body Response" doc:id="f68109d8-ba2a-4008-8458-30035ce4d074" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	codeResponse: vars.httpStatus as String ,
	messageResponse: payload.WSResponseHeader.Service.statusDetail[0].errorDetailCode,
	serviceOrder: if(payload.Service != null)[
    {
      phone: payload.Service.Phone,
      billingAccount: payload.Service.Billing_Account,
      status: payload.Service.Status,
      "type": payload.Service.Type,
      contractedOffer: {
        name: payload.Service.Contracted_Offer.Name,
        description: payload.Service.Contracted_Offer.Description,
        value: payload.Service.Contracted_Offer.Value,
        currency: payload.Service.Contracted_Offer.Currency
      }
    }
  ] else []
	
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>
	<sub-flow name="post-reconexion-orchestratorSub_Flow" doc:id="90965a0f-df9d-4460-b91f-6947af3ccfa3">
		<set-variable value="#[attributes.headers]" doc:name="Set Variable" doc:id="95dd46fa-af30-404b-b9c2-a4df17053153" variableName="headers" />
		<ee:transform doc:name="Set Body Request" doc:id="38a7e433-d537-4264-b8ca-57b6e47a6be4">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  "WSRequestHeader": {
    "System": {
      "name": vars.headers.name,
      "correlationID": vars.headers."X-CORRELATION-ID",
      "processingServer": ""
    },
    "Property": []
  },
  "WSRequestBody": {
    "Audit": {
      "Canal": vars.headers.name
    },
    "Document_Number": payload.serviceOrder.customer.documentNumber,
    "Document_Type": payload.serviceOrder.customer.documentType,
    "Phone": payload.serviceOrder.customer.phone
  }
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<flow-ref doc:name="Flow Reference" doc:id="816982ea-2239-4998-9f4b-64fc59a30e83" name="post-reconexion-clientSub_Flow" />
		<set-variable value='#[if(payload.WSResponseHeader.Service.status == "FAIL" and payload.WSResponseHeader.Service.statusDetail[0].errorCode == "BOTERROR")&#10; 500&#10;else&#10; 200]' doc:name="Set Http Status" doc:id="e6693b96-4a10-4db9-bbe6-03a687f5a3e9" variableName="httpStatus" />
		<ee:transform doc:name="Set Body Response" doc:id="5858c2e7-ca22-4807-a3ce-ca63ce82d7e2">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json

var mensaje = payload.WSResponseHeader.Service.statusDetail[0].errorMessageUser
---
{
	codeResponse: vars.httpStatus as String ,
	messageResponse: if(mensaje != null) mensaje else payload.WSResponseHeader.Service.statusDetail[0].errorMessage default "",
	order: if(payload.WSResponseBody.CUN != null)[
		{
			cun: payload.WSResponseBody.CUN default "",
			numPqr: payload.WSResponseBody.Num_PQR default "",
			orderNumber: payload.WSResponseBody.Order_Number default ""
		}
	]else []
	
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>
	<sub-flow name="post-relocate-orchestratorSub_Flow" doc:id="c1b1277a-b617-4e7e-bd94-dfe1c0d3da9c" >
		<set-variable value="#[attributes.headers]" doc:name="Set Variable" doc:id="fcbf2dfb-46d1-4b98-af36-1a9258d1debd" variableName="headers" />
		<ee:transform doc:name="Set Body Request" doc:id="fda67ebd-7bdc-4788-b775-2e72423c20ba" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  "WSRequestHeader": {
    "System": {
      "name": vars.headers.name,
      "correlationID": vars.headers."X-CORRELATION-ID",
      "processingServer": ""
    },
    "Property": []
  },
  "WSRequestBody": {
    "Audit": {
      "Canal": vars.headers.name
    },
    "Cod_DANE_City": payload.serviceOrder.detailOrder.codDaneCity default "",
    "Cod_DANE_Department": payload.serviceOrder.detailOrder.codDaneDepartment default "",
    "Keep_IPs": payload.serviceOrder.detailOrder.keepIps default "",
    "Keep_Number": payload.serviceOrder.detailOrder.keepNumber default "",
    "Mailbox": payload.serviceOrder.detailOrder.mailbox default "",
    "Latitude": payload.serviceOrder.detailOrder.latitude default "",
    "Longitude": payload.serviceOrder.detailOrder.longitude default "",
    "Phone": payload.serviceOrder.customer.phone default "",
    "Plan": payload.serviceOrder.detailOrder.plan default "",
  }
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<flow-ref doc:name="Flow Reference" doc:id="eb91d815-eca0-42c9-a302-52efab4337df" name="post-relocate-clientSub_Flow" />
		<set-variable value='#[if(payload.WSResponseHeader.Service.status == "FAIL" and payload.WSResponseHeader.Service.statusDetail[0].errorCode == "BOTERROR")&#10; 500&#10;else&#10; 200]' doc:name="Set Http Status" doc:id="8e1e84e9-8dfe-47bd-b672-7bf3bd892621" variableName="httpStatus" />
		<ee:transform doc:name="Set Body Response" doc:id="c1ca7103-0965-428b-bdf0-5a2ec9dff4eb" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	codeResponse: vars.httpStatus as String ,
	messageResponse: payload.WSResponseHeader.Service.statusDetail[0].errorDetailCode,
	order: payload.WSResponseBody.Message
	
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>
	<sub-flow name="post-suspendvoluntarily-orchestratorSub_Flow" doc:id="bf711127-24bc-4178-a082-716b1c8ac471" >
		<set-variable value="#[attributes.headers]" doc:name="Set Variable" doc:id="78bb1ea2-89af-45f4-bf17-5bcd939ffa00" variableName="headers" />
		<ee:transform doc:name="Set Body Request" doc:id="8173a204-0254-4994-9a60-e19ae675c169" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  "WSRequestHeader": {
    "System": {
      "name": vars.headers.name,
      "correlationID": vars.headers."X-CORRELATION-ID",
      "processingServer": ""
    },
    "Property": []
  },
  "WSRequestBody": {
    "Audit": {
      "Canal": vars.headers.name
    },
    
    "Contact_Email": payload.serviceOrder.detailOrder.contactEmail default "",
    "Contact_Phone": payload.serviceOrder.detailOrder.contactPhone default "",
    "Document_Number": payload.serviceOrder.customer.documentNumber default "",
    "Document_Type": payload.serviceOrder.customer.documentType default "",
    "Finish_Date": payload.serviceOrder.detailOrder.finishDate default "",
    "Initial_Date": payload.serviceOrder.detailOrder.initialDate default "",
    "Phone": payload.serviceOrder.customer.phone default ""
    
   }
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<flow-ref doc:name="Flow Reference" doc:id="9b9d9405-7e46-448e-9328-fba8b70e1c98" name="post-suspendvoluntarily-clientSub_Flow" />
		<set-variable value='#[if(payload.WSResponseHeader.Service.status == "FAIL" and payload.WSResponseHeader.Service.statusDetail[0].errorCode == "BOTERROR")&#10; 500&#10;else&#10; 200]' doc:name="Set Http Status" doc:id="bf91b6ba-f19f-413c-ac51-227bb08c8c87" variableName="httpStatus" />
		<ee:transform doc:name="Set Body Response" doc:id="5b14b1c7-1ac7-4785-b54c-3f0c78d7f281" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	codeResponse: vars.httpStatus as String ,
	messageResponse: payload.WSResponseHeader.Service.statusDetail[0].errorDetailCode,
	order: [
    {
	    cun: payload.WSResponseBody.CUN default "",
	    numPqr: payload.WSResponseBody.Num_PQR default "",
	    orderNumber: payload.WSResponseBody.Order_Number default ""
    }
  ]
	
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>
	<sub-flow name="post-suspendbytheft-orchestratorSub_Flow" doc:id="7f560c55-c9f1-4b40-92a0-a7479ce54248" >
		<set-variable value="#[attributes.headers]" doc:name="Set Variable" doc:id="87708464-677b-4804-b0af-34287c223a47" variableName="headers" />
		<ee:transform doc:name="Set Body Request" doc:id="5621e2a5-d11a-455d-8e56-da48b2b126ab" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  "WSRequestHeader": {
    "System": {
      "name": vars.headers.name,
      "correlationID": vars.headers."X-CORRELATION-ID",
      "processingServer": ""
    },
    "Property": []
  },
    "WSRequestBody": {
    "Audit": {
      "Canal": vars.headers.name
    },
    "Address": payload.serviceOrder.detailOrder.address default "",
    "City": payload.serviceOrder.detailOrder.city default "",
    "Contact_Email": payload.serviceOrder.detailOrder.contactEmail default "",
    "Contact_Phone": payload.serviceOrder.detailOrder.contactPhone default "",
    "Department": payload.serviceOrder.detailOrder.department default "",
    "Document_Number": payload.serviceOrder.customer.documentNumber default "",
    "Document_Type": payload.serviceOrder.customer.documentType default "",
    "IMEI": payload.serviceOrder.detailOrder.imei default "",
    "Mail": payload.serviceOrder.detailOrder.mail default "",
    "Phone": payload.serviceOrder.customer.phone default "",
    "Violence": payload.serviceOrder.detailOrder.violence default "",
    "Younger": payload.serviceOrder.detailOrder.younger default "",
    "Weapon": payload.serviceOrder.detailOrder.weapon default "",
    "Suspension_Period": payload.serviceOrder.detailOrder.suspensionPeriod default ""
  }
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<flow-ref doc:name="Flow Reference" doc:id="4821953d-6dc7-459f-8002-b7bbb36cc82d" name="post-suspendbytheft-clientSub_Flow" />
		<set-variable value='#[if(payload.WSResponseHeader.Service.status == "FAIL" and payload.WSResponseHeader.Service.statusDetail[0].errorCode == "BOTERROR")&#10; 500&#10;else&#10; 200]' doc:name="Set Http Status" doc:id="55b98ac5-ff84-4276-aef4-d74445fcfe3e" variableName="httpStatus" />
		<ee:transform doc:name="Set Body Response" doc:id="55e2d5f5-08ac-402f-a3d0-bad805a95e7c" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	codeResponse: vars.httpStatus as String ,
	messageResponse: payload.WSResponseHeader.Service.statusDetail[0].errorDetailCode,
	order: [
    {
	    cun: payload.WSResponseBody.CUN default "",
	    numPqr: payload.WSResponseBody.Num_PQR default "",
	    orderNumber: payload.WSResponseBody.Order_Number default ""
    }
  ]
	
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>
	<sub-flow name="post-suspendbyloss-orchestratorSub_Flow" doc:id="98db187a-e345-4c25-83b8-1e1a941128fa" >
		<set-variable value="#[attributes.headers]" doc:name="Set Variable" doc:id="a11486d6-0228-41fe-9fb0-5b6e798a4e04" variableName="headers" />
		<ee:transform doc:name="Set Body Request" doc:id="fb035913-4d5b-4617-b24a-45db70f321e3" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  "WSRequestHeader": {
    "System": {
      "name": vars.headers.name,
      "correlationID": vars.headers."X-CORRELATION-ID",
      "processingServer": ""
    },
    "Property": []
  },
  "WSRequestBody": {
    "Audit": {
      "Canal": vars.headers.name
    },
    "Address": payload.serviceOrder.detailOrder.address default "",
  "IMEI": payload.serviceOrder.detailOrder.imei default "",
  "City": payload.serviceOrder.detailOrder.city default "",
  "Contact_Email": payload.serviceOrder.detailOrder.contactEmail default "",
  "Contact_Phone": payload.serviceOrder.detailOrder.contactPhone default "",
  "Department": payload.serviceOrder.detailOrder.department default "",
  "Document_Number": payload.serviceOrder.customer.documentNumber default "",
  "Document_Type": payload.serviceOrder.customer.documentType default "",
  "Phone": payload.serviceOrder.customer.phone default ""
  }
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<flow-ref doc:name="Flow Reference" doc:id="bb84d9a2-3dfa-4680-81b2-64f62a89f15f" name="post-suspendbyloss-clientSub_Flow" />
		<set-variable value='#[if(payload.WSResponseHeader.Service.status == "FAIL" and payload.WSResponseHeader.Service.statusDetail[0].errorCode == "BOTERROR")&#10; 500&#10;else&#10; 200]' doc:name="Set Http Status" doc:id="b62fe51c-0488-497d-b4ba-ad836c558d9a" variableName="httpStatus" />
		<ee:transform doc:name="Set Body Response" doc:id="8c31b064-249e-4659-b626-949f1e018cc8" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	codeResponse: vars.httpStatus as String ,
	messageResponse: payload.WSResponseHeader.Service.statusDetail[0].errorDetailCode,
	order: [
    {
	    cun: payload.WSResponseBody.CUN default "",
	    numPqr: payload.WSResponseBody.Num_PQR default "",
	    orderNumber: payload.WSResponseBody.Order_Number default ""
    }
  ]
	
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>
</mule>
