<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="post-reconexion-orchestratorSub_Flow" doc:id="90965a0f-df9d-4460-b91f-6947af3ccfa3" >
		<set-variable value="#[attributes.headers]" doc:name="Set Variable" doc:id="95dd46fa-af30-404b-b9c2-a4df17053153" variableName="headers" />
		<ee:transform doc:name="Set Body Request" doc:id="38a7e433-d537-4264-b8ca-57b6e47a6be4" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  "WSRequestHeader": {
    "System": {
      "name": vars.headers.system,
      "correlationID": vars.headers."X-CORRELATION-ID",
      "processingServer": ""
    },
    "Property": []
  },
  "WSRequestBody": {
    "Audit": {
      "Canal": vars.headers.system
    },
    "Network_Type": "",
    "Phone": payload.serviceOrder.customer.phone,
    "Service_Type": "",
    "Reconnection_Reason": ""
  }
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<flow-ref doc:name="Flow Reference" doc:id="816982ea-2239-4998-9f4b-64fc59a30e83" name="post-reconexion-clientSub_Flow"/>
		<set-variable value='#[if(payload.WSResponseHeader.Service.status == "FAIL" and payload.WSResponseHeader.Service.statusDetail[0].errorCode == "BOTERROR")&#10; 500&#10;else&#10; 200]' doc:name="Set Http Status" doc:id="e6693b96-4a10-4db9-bbe6-03a687f5a3e9" variableName="httpStatus" />
		<ee:transform doc:name="Set Body Response" doc:id="5858c2e7-ca22-4807-a3ce-ca63ce82d7e2" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	codeResponse: vars.httpStatus as String ,
	messageResponse: payload.WSResponseHeader.Service.statusDetail[0].errorDetailCode,
	order: payload.WSResponseBody.Message
	
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>
	<sub-flow name="service-order-orchestratorSub_Flow" doc:id="fb825da7-a9af-4c3e-a9c6-bd42c4d40194" >
		<choice doc:name="Choice" doc:id="a715738f-b256-4f56-9a53-2361243ef52b" >
			<when expression='#[upper(payload.serviceOrder.operation) == "RECONEXION"]'>
				<flow-ref doc:name="Flow Reference" doc:id="302103f2-678a-48a4-87ec-bbd04c655d71" name="post-reconexion-orchestratorSub_Flow"/>
			</when>
			<when expression='#[upper(payload.serviceOrder.operation) == "TRASLADO"]'>
				<flow-ref doc:name="Flow Reference" doc:id="eee64e5d-51a2-496d-8e2b-ee214a02d68a" name="post-reconexion-orchestratorSub_Flow"/>
			</when>
			<otherwise >
				<set-variable value='#[500]' doc:name="Set Http Status1" doc:id="96308fc6-c5f4-4346-bfd5-c89fded2e300" variableName="httpStatus" />
				<ee:transform doc:name="Set Body Response1" doc:id="8b830410-216a-4624-8a64-991ddc6f3423">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	codeResponse: vars.httpStatus as String ,
	messageResponse: "Ruta no definida segun el campo operacion"
	
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="get-service-order-orchestratorSub_Flow" doc:id="69503731-3fd5-4491-9c40-e290a965105d" >
		<set-variable value="#[attributes.headers]" doc:name="Set Variable" doc:id="c777f918-ae9d-492b-8b06-22c204d76d32" variableName="headers" />
		<set-variable value="#[attributes.queryParams]" doc:name="Set Paremeters" doc:id="c1861e89-16e5-45e9-9092-fea1c43056d3" variableName="parameters" />
		<ee:transform doc:name="Transform FILTROS PARAM to JSON" doc:id="58a9bfcc-a382-4cc2-ac9b-8b2bd3b5c786">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
var raw = vars.parameters.FILTERS
var lista = raw splitBy ";"
var pares = lista map (item) -> item splitBy ":"
var filtrados = pares filter (kv) -> sizeOf(kv) == 2
var resultado = filtrados reduce (pair, acc = {}) -> acc ++ {
  (pair[0] as String {lowerFirst: true}): pair[1]
}
---
{
  filtros: resultado
}
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<ee:transform doc:name="Set Body Request" doc:id="bb18046e-9bc3-4e9f-b346-bdf52229b618" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  "WSRequestHeader": {
    "System": {
      "name": vars.headers.system,
      "correlationID": vars.headers."X-CORRELATION-ID",
      "processingServer": ""
    },
    "Property": []
  },
  "WSRequestBody": {
    "Audit": {
      "Canal": vars.headers.system
    },
    "Filter": {
      "Billing_Account": true,
      "Contracted_Offer": true
    },
    "Phone": payload.filtros.ConecctionNumber default ""
  }
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<flow-ref doc:name="Flow Reference" doc:id="20fafde4-844e-4f81-87de-45c02417b507" name="post-services-get-clientSub_Flow" />
		<set-variable value='#[if(payload.WSResponseHeader.Service.status == "FAIL" and payload.WSResponseHeader.Service.statusDetail[0].errorCode == "BOTERROR")&#10; 500&#10;else&#10; 200]' doc:name="Set Http Status" doc:id="d3684179-434a-42ed-b8d9-237354b4c8b7" variableName="httpStatus" />
		<ee:transform doc:name="Set Body Response" doc:id="f68109d8-ba2a-4008-8458-30035ce4d074" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	codeResponse: vars.httpStatus as String ,
	messageResponse: payload.WSResponseHeader.Service.statusDetail[0].errorDetailCode,
	serviceOrder: if(payload.Service != null)[
    {
      phone: payload.Service.Phone,
      billingAccount: payload.Service.Billing_Account,
      status: payload.Service.Status,
      "type": payload.Service.Type,
      contractedOffer: {
        name: payload.Service.Contracted_Offer.Name,
        description: payload.Service.Contracted_Offer.Description,
        value: payload.Service.Contracted_Offer.Value,
        currency: payload.Service.Contracted_Offer.Currency
      }
    }
  ] else []
	
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>
	<sub-flow name="post-relocate-orchestratorSub_Flow" doc:id="c1b1277a-b617-4e7e-bd94-dfe1c0d3da9c" >
		<set-variable value="#[attributes.headers]" doc:name="Set Variable" doc:id="fcbf2dfb-46d1-4b98-af36-1a9258d1debd" variableName="headers" />
		<ee:transform doc:name="Set Body Request" doc:id="fda67ebd-7bdc-4788-b775-2e72423c20ba" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  "WSRequestHeader": {
    "System": {
      "name": vars.headers.system,
      "correlationID": vars.headers."X-CORRELATION-ID",
      "processingServer": ""
    },
    "Property": []
  },
  "WSRequestBody": {
    "Audit": {
      "Canal": vars.headers.system
    },
    "Network_Type": "",
    "Phone": payload.serviceOrder.customer.phone,
    "Service_Type": "",
    "Reconnection_Reason": ""
  }
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<flow-ref doc:name="Flow Reference" doc:id="eb91d815-eca0-42c9-a302-52efab4337df" name="post-relocate-clientSub_Flow" />
		<set-variable value='#[if(payload.WSResponseHeader.Service.status == "FAIL" and payload.WSResponseHeader.Service.statusDetail[0].errorCode == "BOTERROR")&#10; 500&#10;else&#10; 200]' doc:name="Set Http Status" doc:id="8e1e84e9-8dfe-47bd-b672-7bf3bd892621" variableName="httpStatus" />
		<ee:transform doc:name="Set Body Response" doc:id="c1ca7103-0965-428b-bdf0-5a2ec9dff4eb" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	codeResponse: vars.httpStatus as String ,
	messageResponse: payload.WSResponseHeader.Service.statusDetail[0].errorDetailCode,
	order: payload.WSResponseBody.Message
	
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>
</mule>
