<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="post-replacement-plan-orchestratorSub_Flow" doc:id="32437755-f8fb-49b1-a62d-c0514497f550" >
		<choice doc:name="Choice" doc:id="5f5aa057-7aba-4120-b344-e6a6042267ac" >
			<when expression='#[(payload.modalidad == "pospago-pospago" or payload.modalidad == "pospago-prepago" or payload.modalidad == "prepago-prepago")]'>
				<flow-ref doc:name="Get subscription by msisdn" doc:id="0627f29e-f623-4782-bb1e-c0cf97ffea1a" name="get-subscription-client-by-msisdn"/>
				<ee:transform doc:name="createOrder payload" doc:id="11eb4714-28dc-4e4c-a707-4e24aa66a9ac" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  "type": "RETAIL",
  "salesChannel": "OWN_CALLCENTER",
  "status": "CONFIRMED",
  "packages": [
    {
      "id": vars.packageId
    }
  ],
    "subscription": {
    "id": payload.content.id[0]
    }
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<flow-ref doc:name="createOrder" doc:id="8bec3956-8d07-44c3-a59e-5ff7f8dff8a1" name="post-order-client"/>
				<flow-ref doc:name="apply order" doc:id="4464449d-ca94-4d50-bd0c-f7b3446d0776" name="patch-endOrder-client"/>
				<ee:transform doc:name="response" doc:id="14e70cee-6988-4bc3-877a-9868ceaefb87" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  "codigo": "OK",
  "descripcion": "Cambio exitoso"
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</when>
			<when expression='#[payload.modalidad == "prepago-pospago"]' >
				<flow-ref doc:name="Get subscription by msisdn" doc:id="3e9553a6-650a-4243-96c5-fc4f4dd8ee40" name="get-subscription-client-by-msisdn" />
				<ee:transform doc:name="createOrder payload" doc:id="7f32cd40-548a-48e5-9cdb-f64100cf38e9" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  "type": "RETAIL",
  "salesChannel": "OWN_CALLCENTER",
  "status": "CONFIRMED",
  "packages": [
    {
      "id": vars.packageId
    }
  ],
    "subscription": {
    "id": payload.content.id[0]
    }
}]]></ee:set-payload>
					</ee:message>
					<ee:variables >
					</ee:variables>
				</ee:transform>
				<flow-ref doc:name="createOrder" doc:id="6f153f96-302d-4ee0-9277-79ccd0876a9c" name="post-order-client"/>
				<try doc:name="Try" doc:id="7d7fe1a4-c1c3-46cb-b5d3-6dd2656ac88d" >
					<ee:transform doc:name="create billingAccount payload" doc:id="f0204924-f425-4b9a-bc0a-c0fe5250d3e3">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  "name": "Creating a new BillingAccount",
  "subscriber": {
    "id": vars.orderObject.subscriber.id
  },
  "cycleConfig": {
    "cycleDay": vars.pam 
    }
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
					<flow-ref doc:name="create Billing Account" doc:id="c6fefab1-2b4a-46e4-ae9c-642d7883e0f7" name="post-billingBA-client" />
					<ee:transform doc:name="Move billingAccount payload" doc:id="105a4297-0067-47e0-8553-1d31b8bae3d0">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    "billingAccount": {
        "id" : vars.billingAccountObject.id,
        "name"  : "Moving subscription to billing account cycle"
    }
}]]></ee:set-payload>
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="subscriptionAction"><![CDATA[%dw 2.0
output application/java
---
p('jsc-sapi.createBillingAccount.subscription.action') //PROP]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
					<flow-ref doc:name="Move billingAccount" doc:id="a66cbd6b-e189-45c0-8812-52135db5a4c0" name="patch-billingSubscription-client" />
					<error-handler >
						<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="16ed438e-423b-4e38-bbf0-062d4b63a928">
							<logger level="INFO" doc:name="Logger" doc:id="93180830-4465-4c49-996d-1892d32e58de" />
						</on-error-continue>
					</error-handler>
				</try>
				<flow-ref doc:name="apply order" doc:id="94e4d36c-d742-4ca3-ae86-ab10f0b59227" name="patch-endOrder-client" />
				<ee:transform doc:name="response" doc:id="8217f437-9e32-4282-896a-d771d2ccd81a" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  "codigo": "OK",
  "descripcion": "Cambio exitoso"
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</when>
			<otherwise >
				<ee:transform doc:name="Error" doc:id="c328b424-aeb1-44cf-b4d7-e2212de3dc7c" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  "status": 501,
  "code": "NOT_IMPLEMENTED",
  "message": {
    "message": "[modalidad] " ++ payload.modalidad ++ ", is not implemented"
  },
  "messageServer": "",
  "cause": [
    {
      "origin": "service-papi-services",
      "message": "org.mule.module.apikit.api.exception.BadRequestException"
    }
  ]
}]]></ee:set-payload>
					</ee:message>
					<ee:variables >
						<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/java
---
501]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
			</otherwise>
		</choice>
	</sub-flow>
</mule>
