<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="post-air-recharge-orchestratorSub_Flow" doc:id="0d9b263d-68d6-42c4-a7a2-4c323036bf6a" >
		<choice doc:name="Charge money or plan?" doc:id="5f8ca90c-6dbb-4423-ae2a-b0689bd19db6" >
			<when expression="#[p('global-vars.refill') == payload.methodCall.methodName]" >
				<ee:transform doc:name="Cargar Dinero" doc:id="8ffe71b9-f582-447a-a4c4-4af4123484eb">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/xml
var info = payload.methodCall.member
---
{
	methodCall: {
		methodName: "Refill",
		params: [{
			param: {
				value: {
					struct: {
						member: {
							name: "subscriberNumberNAI",
							value: {
								i4: 1
							}
						},
						member: {
							name: "refillProfileID",
							value: "R000"
						},
						member: {
							name: "originNodeType",
							value: "01"
						},
						member: {
							name: "transactionAmount",
							value: info.transactionAmount
						},
						member: {
							name: "refillType",
							value: {
								i4: 2
							}
						},
						member: {
							name: "subscriberNumber",
							value: "57" ++ info.subscriberNumber
						},
						member: {
							name: "originTransactionID",
							value: info.originTransactionID
						},
						member: {
							name: "originTimeStamp",
							value: {"dateTime.iso8601":  (now() >> "America/Bogota") as String {format: "yyyyMMdd'T'HH:mm:ssXX"}}
						},
						member: {
							name: "transactionCurrency",
							value: "COP"
						},
						member: {
							name: "externalData1",
							value: "1"
						},
						member: {
							name: "originHostName",
							value: info.originHostName
						}
					}
				}
			}
		}]
	}
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</when>
			<otherwise >
				<ee:transform doc:name="Cargar Paquete" doc:id="69f2032c-eeb2-4c86-b25d-d837d03dd601">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/xml
var info = payload.methodCall.member
---
{
	methodCall: {
		methodName: "Refill",
		params: [{
			param: {
				value: {
					struct: {
						member: {
							name: "originNodeType",
							value: {
                                string: "01"
                            }
						},
						member: {
							name: "originHostName",
							value: {
                                string: info.originHostName
                            }
						},
						member: {
							name: "originTransactionID",
							value: {
                                string: info.originTransactionID
                            }
						},
                        member: {
							name: "originTimeStamp",
							value: { "dateTime.iso8601": (now() >> "America/Bogota") as String {format: "yyyyMMdd'T'HH:mm:ssXX"}}
						},
                        member: {
							name: "subscriberNumber",
							value: {
                                string: "57" ++ info.subscriberNumber
                            }
						},
                        member: {
							name: "transactionAmount",
							value: {
                                string: info.transactionAmount
                            }
						},
                        member: {
							name: "transactionCurrency",
							value: {
                                string: "COP"
                            }
						},
                        member: {
							name: "externalData1",
							value: {
                                string: "1"
                            }
						},
                        member: {
							name: "refillProfileID",
							value: {
                                string: info.refillProfileID
                            }
						}
					}
				}
			}
		}]
	}
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</otherwise>
		</choice>
		<logger level="INFO" doc:name="Logger" doc:id="fac7d039-dfa8-4edc-a4f0-bb32ad8657ed" message="#[payload]"/>
		<flow-ref doc:name="Go to Client" doc:id="5e55c450-6989-4898-bcfb-964bf7ad9d9f" name="air-clientSub_Flow" />
		<ee:transform doc:name="Map Out" doc:id="f15e89cc-5154-4914-ba6e-83fc4971b708" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
if(!isEmpty(payload.methodResponse.fault))
	{
		id: null,
		status: "Fail",
		description: "Error in request to AIR"
	}
else if((payload.methodResponse.params.param.value.struct.*member filter $.name == "responseCode")[0].value.i4 != "0")
	{
		id: (payload.methodResponse.params.param.value.struct.*member filter $.name == "responseCode")[0].value.i4 default null,
		status: "Fail",
		description: "Error in AIR platform"
	}
else
	do{
		var originTransactionID = (payload.methodResponse.params.param.value.struct.*member filter $.name == "originTransactionID")[0].value.string
		---
		{
			id: originTransactionID,
			status: "Successful"
		}
	}
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<set-variable value='#[if(payload.status == "Fail") 500 else 200]' doc:name="httpStatus" doc:id="367756cf-5c68-494f-9660-fc87589f513f" variableName="httpStatus"/>
	</sub-flow>
</mule>
