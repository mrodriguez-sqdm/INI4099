<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:java="http://www.mulesoft.org/schema/mule/java" xmlns:crypto="http://www.mulesoft.org/schema/mule/crypto"
	xmlns:wsc="http://www.mulesoft.org/schema/mule/wsc"
	xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/wsc http://www.mulesoft.org/schema/mule/wsc/current/mule-wsc.xsd
http://www.mulesoft.org/schema/mule/crypto http://www.mulesoft.org/schema/mule/crypto/current/mule-crypto.xsd
http://www.mulesoft.org/schema/mule/java http://www.mulesoft.org/schema/mule/java/current/mule-java.xsd">
	<sub-flow name="post-document-validation-orchestratorFlow" doc:id="5cbd05f7-d272-4aaa-b0cd-ea0800af78cd" >
		<flow-ref doc:name="Homologate Document" doc:id="f9ac179d-5f13-48ea-b352-a77d6ec4884e" name="homologateDocument" target="responseHomologation" />
		<choice doc:name="Choice" doc:id="f21e7bf7-8e2b-4200-b35d-6b370d63ac91">
			<when expression="#[vars.responseHomologation.homologation != null]">
				<parse-template doc:name="Parse Template" doc:id="484c39df-7c61-4c5d-8755-32fbfb77ef6d" location="soap\schemas\templates\soap-post-transunion.xml" target="parseTemplateOut" targetValue="#[payload]"/>
				<java:new doc:name="New" doc:id="4e41ec1e-db58-442d-8731-84f3bf87f7bb" class="com.globant.Connectivity.XmlSign" constructor="XmlSign()"/>
				<java:invoke doc:name="Invoke XmlSign" doc:id="4d2c6e69-8b80-44d3-bd36-e9e2f7a97104" instance="#[payload]" class="com.globant.Connectivity.XmlSign" method="signXml(String,String,String,String)">
					<java:args ><![CDATA[#[{
	inputXML: vars.parseTemplateOut,
	passJks: p('WSResponseVerificaDocumentoCIFIN.auth.tls.keypass'),
	path: p('WSResponseVerificaDocumentoCIFIN.auth.tls.pathJava'),
	aliasStr: p('WSResponseVerificaDocumentoCIFIN.auth.tls.alias'),
}]]]></java:args>
				</java:invoke>
				<ee:transform doc:name="To One Line" doc:id="f2fc299d-7a7a-48d5-82b6-b21ea733834f">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output text/plain
---
payload]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<flow-ref doc:name="Go to Transunion Client" doc:id="7cbda668-ad90-459b-aff1-bb2138712950" name="post-document-validationSub_Flow" />
				<choice doc:name="Choice" doc:id="cb13c38d-409c-485a-8e54-dfa54f49ded2">
					<when expression="#[vars.errorDesc == null]">
						<ee:transform doc:name="Respuesta Consulta" doc:id="2315b7f9-e285-448f-bdc6-fab36bd49896">
							<ee:message>
							</ee:message>
							<ee:variables>
								<ee:set-variable variableName="respuestaConsulta"><![CDATA[%dw 2.0
output application/json
---
read(payload.Envelope.Body.consultaXmlResponse.consultaXmlReturn replace "\n" with "", "application/xml").CIFIN.Tercero.RespuestaConsulta as String default "Error"]]></ee:set-variable>
								<ee:set-variable variableName="mensajeError" ><![CDATA[%dw 2.0
output application/json
---
read(payload.Envelope.Body.consultaXmlResponse.consultaXmlReturn replace "\n" with "", "application/xml").CifinError.Error.MensajeError]]></ee:set-variable>
							</ee:variables>
						</ee:transform>
						<flow-ref doc:name="Map Output" doc:id="a4d1c9ee-8542-4ac3-91db-d0dbb75379bb" name="mapOutput" />
					</when>
					<otherwise>
						<ee:transform doc:name="Error Output CIFIN" doc:id="048f2f91-5586-48c1-9acb-1a3f9cebf127">
							<ee:message>
								<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  "WSResponseVerificaDocumentoCIFIN": {
    "ResponseCIFIN": {
      "error": {
        "sNumeroIdentificacion": {
          "value-of": vars.inputBody.sNumDocumento
        },
        "sOperacion": {
          "value-of": "CONSULTA"
        },
        "sCodigoError": {
          "value-of": "-1"
        },
        "sMensajeError": {
          "value-of": "Se presento un error al momento de realizar la verificaciÃ³n de documento con CIFIN"
        }
      }
    }
  }
}]]></ee:set-payload>
							</ee:message>
							<ee:variables>
								<ee:set-variable variableName="httpStatus"><![CDATA[%dw 2.0
output application/java
---
500]]></ee:set-variable>
							</ee:variables>
						</ee:transform>
						<async doc:name="Async" doc:id="f3be356a-6eb2-425b-a314-c28212494627">
							<flow-ref doc:name="RegisterLog" doc:id="2610a100-3e96-487c-aaa5-baae9aae75bb" name="registerLog_documentValidation" />
						</async>
					</otherwise>
				</choice>
			</when>
			<otherwise>
				<ee:transform doc:name="Error Output Homologation" doc:id="d0ebfa4c-a3c0-447b-b546-935c2e95e57b">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  "WSResponseVerificaDocumentoCIFIN": {
    "ResponseCIFIN": {
      "error": {
        "sNumeroIdentificacion": {
          "value-of": vars.inputBody.sNumDocumento
        },
        "sOperacion": {
          "value-of": "CONSULTA"
        },
        "sCodigoError": {
          "value-of": "-1"
        },
        "sMensajeError": {
          "value-of": "Se presento un error al momento de realizar la homologacion del documento."
        }
      }
    }
  }
}]]></ee:set-payload>
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="httpStatus"><![CDATA[%dw 2.0
output application/java
---
500]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<async doc:name="Async" doc:id="0959dcd5-9db6-48d2-b403-5e61a31167f9">
					<flow-ref doc:name="RegisterLog" doc:id="8c799ce1-1a2b-4664-91a0-6f5a9bfe839c" name="registerLog_documentValidation" />
				</async>
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="mapOutput" doc:id="6b7b1638-20e7-4a3b-83df-6459279644ca" >
		<choice doc:name="Choice" doc:id="b1af651a-5ff2-416c-81b9-f028f8598a0a" >
			<when expression='#[vars.RespuestaConsulta == "02"]' >
				<ee:transform doc:name="Sucess Output" doc:id="f3d35b02-c66b-4286-b207-042395bbc27f" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
var responseFormatted = read(payload.Envelope.Body.consultaXmlResponse.consultaXmlReturn replace "\n" with "", "application/xml").CIFIN.Tercero
---
{
    "WSResponseVerificaDocumentoCIFIN": {
      "ResponseCIFIN": {
        "infoCliente": {
          "sTipoIdentificacion": responseFormatted.TipoIdentificacion,
          "sNumeroIdentificacion": responseFormatted.NumeroIdentificacion,
          "sNombreTitular": responseFormatted.NombreTitular,
          "sNombreCiiu": responseFormatted.NombreCiiu,
          "sLugarExpedicion": responseFormatted.LugarExpedicion,
          "sFechaExpedicion": responseFormatted.FechaExpedicion,
          "sEstado": responseFormatted.Estado,
          "sEstadoTitular": responseFormatted.EstadoTitular,
          "sRangoEdad": responseFormatted.RangoEdad,
          "sCodigoCiiu": responseFormatted.CodigoCiiu,
          "sCodigoDepartamento": responseFormatted.CodigoDepartamento,
          "sCodigoMunicipio": responseFormatted.CodigoMunicipio,
          "sFecha": responseFormatted.Fecha,
          "sHora": responseFormatted.Hora,
          "sEntidad": responseFormatted.Entidad,
          "sRespuestaConsulta": responseFormatted.RespuestaConsulta,
          "sNombre1": responseFormatted.Nombre1,
          "sNombre2": responseFormatted.Nombre2,
          "sDe": responseFormatted.De,
          "sApellido1": responseFormatted.Apellido1,
          "sApellido2": responseFormatted.Apellido2,
          "sGenero": responseFormatted.Genero,
          "sCodigoEstado": responseFormatted.CodigoEstado,
          "sReporteConsolidado": {
            "sContCuentasAhorros": responseFormatted.ReporteConsolidado.ContCuentasAhorros,
            "sContCuentasCorrientes": responseFormatted.ReporteConsolidado.ContCuentasCorrientes,
            "sContFinanciero": responseFormatted.ReporteConsolidado.ContFinanciero,
            "sContSolidario": responseFormatted.ReporteConsolidado.ContSolidario,
            "sContRealServicios": responseFormatted.ReporteConsolidado.ContRealServicios,
            "sContRealComercio": responseFormatted.ReporteConsolidado.ContRealComercio
          }
        }
      }
    }
  }]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<async doc:name="Async" doc:id="57e9b901-5a55-4985-9041-f4e5c2093b94" >
					<flow-ref doc:name="RegisterLog" doc:id="127acabf-f14c-4c2a-95fb-b753f5f427e1" name="registerLog_documentValidation" />
				</async>
			</when>
			<otherwise >
				<ee:transform doc:name="Error Output CIFIN" doc:id="3e8176bb-e268-4fd7-a79b-b91c079ea909" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  "WSResponseVerificaDocumentoCIFIN": {
    "ResponseCIFIN": {
      "error": {
        "sNumeroIdentificacion": {
          "value-of": vars.inputBody.sNumDocumento
        },
        "sOperacion": {
          "value-of": "CONSULTA"
        },
        "sCodigoError": {
          "value-of": "-1"
        },
        "sMensajeError": {
          "value-of": vars.mensajeError default "Consulta no exitosa o Titular no existe en Cifin"
        }
      }
    }
  }
}]]></ee:set-payload>
					</ee:message>
					<ee:variables >
						<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/java
---
500]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<async doc:name="Async" doc:id="5f24b62a-9e39-4bf4-b86d-32f268030323" >
					<flow-ref doc:name="RegisterLog" doc:id="0a18bae1-7f7f-4954-9460-a4c3343c7e17" name="registerLog_documentValidation" />
				</async>
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="registerLog_documentValidation" doc:id="b943d6e5-5627-40c2-bf36-0007d7cbae44" >
		<choice doc:name="Choice" doc:id="42790c10-0cf1-4e8b-bc43-60a5dbc90d99">
			<when expression='#[vars.errorDesc == null and vars.respuestaConsulta == "02"]'>
				<ee:transform doc:name="Log Success" doc:id="01a8462d-b033-456a-a6f3-31d534319899">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
var infoCliente = payload.WSResponseVerificaDocumentoCIFIN.ResponseCIFIN.infoCliente
---
{
    Identificador_Peticion: correlationId,
    Tipo_Documento: vars.inputBody.sTipoDocumento default "", 
    Numero_Identificacion: vars.inputBody.sNumDocumento as Number default null,
    Numero_Conexion: "",
    Tipo_Transaccion: "VERIFICA DOCUMENTO CIFIN",
    Fecha_Inicio: now(), 
    Fecha_Fin: now(),
    Estado_Transaccion: "",
    Sistema_Origen: "MULESOFT",
    Atributos: [
      {
        name: "FECHA_CONSULTA",
        value: now() as DateTime{format: "dd/MM/yyyy"}
      },
      {
        name: "HORA_CONSULTA",
        value: now() as DateTime{format: "HH:mm"}
      },
      {
        name: "TIPO_IDENTIFICACION",
        value: vars.inputBody.sTipoDocumento default ""
      },
      {
        name: "NUMERO_IDENTIFICACION",
        value: vars.inputBody.sNumDocumento default ""
      },
      {
        name: "APELLIDO",
        value: trim(infoCliente.sApellido1 default "" ++ " " ++ infoCliente.sApellido2 default "")
      },
      {
        name: "NOMBRE",
        value: trim(infoCliente.sNombre1 default "" ++ " " ++ infoCliente.sNombre2 default "")
      },
      {
        name: "TRAMITE",
        value: vars.inputBody.tramite default ""
      },
      {
        name: "TIPO_CONSULTA",
        value: "VERIFICA DOCUMENTO CIFIN"
      },
      {
        name: "USUARIO",
        value: vars.inputBody.usuario default "IVR"
      },
      {
        name: "CANAL",
        value: vars.inputBody.canal default ""
      },
      {
        name: "PROVEEDOR",
        value: vars.inputBody.proveedor default ""
      },
      {
        name: "CIUDAD",
        value: infoCliente.sNombreCiiu default ""
      },
      {
        name: "DEPARTAMENTO",
        value: vars.inputBody.departamento default ""
      },
      {
        name: "ESTADO_ETB",
        value: "CONSULTA EXITOSA"
      },
      {
        name: "SISTEMA_ORIGEN",
        value: "IVR"
      },
      {
        name: "MENSAJE",
        value: write(payload, "application/xml"),
      },
      {
        name: "NIVEL_RIESGO",
        value:  ""
      },
      {
        name: "SCORE",
        value: ""
      },
      {
        name: "ID",
        value: correlationId
      }
      ]
  }]]></ee:set-payload>
			</ee:message>
		</ee:transform>
			</when>
			<otherwise>
				<ee:transform doc:name="Log Error" doc:id="bbb60373-43de-4ff0-8bd7-41446ae19742">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
var infoCliente = payload.WSResponseVerificaDocumentoCIFIN.ResponseCIFIN.infoCliente
---
{
    Identificador_Peticion: correlationId,
    Tipo_Documento: vars.inputBody.sTipoDocumento default "", 
    Numero_Identificacion: vars.inputBody.sNumDocumento as Number default null,
    Numero_Conexion: "",
    Tipo_Transaccion: "VERIFICA DOCUMENTO CIFIN",
    Fecha_Inicio: now(), 
    Fecha_Fin: now(),
    Estado_Transaccion: "",
    Sistema_Origen: "MULESOFT",
    Atributos: [
      {
        name: "FECHA_CONSULTA",
        value: now() as DateTime{format: "dd/MM/yyyy"}
      },
      {
        name: "HORA_CONSULTA",
        value: now() as DateTime{format: "HH:mm"}
      },
      {
        name: "TIPO_IDENTIFICACION",
        value: vars.inputBody.sTipoDocumento default ""
      },
      {
        name: "NUMERO_IDENTIFICACION",
        value: vars.inputBody.sNumDocumento default ""
      },
      {
        name: "APELLIDO",
        value: vars.inputBody.sPrimerApellido default ""
      },
      {
        name: "NOMBRE",
        value: vars.inputBody.sNombre default ""
      },
      {
        name: "TRAMITE",
        value: vars.inputBody.tramite default ""
      },
      {
        name: "TIPO_CONSULTA",
        value: "VERIFICA DOCUMENTO CIFIN"
      },
      {
        name: "USUARIO",
        value: vars.inputBody.usuario default "IVR"
      },
      {
        name: "CANAL",
        value: vars.inputBody.canal default ""
      },
      {
        name: "PROVEEDOR",
        value: vars.inputBody.proveedor default ""
      },
      {
        name: "CIUDAD",
        value: infoCliente.sNombreCiiu default ""
      },
      {
        name: "DEPARTAMENTO",
        value: vars.inputBody.departamento default ""
      },
      {
        name: "ESTADO_ETB",
        value: "ERROR"
      },
      {
        name: "SISTEMA_ORIGEN",
        value: "IVR"
      },
      {
        name: "MENSAJE",
        value: write({"Input": vars.inputBody}, "application/xml"),
      },
      {
        name: "NIVEL_RIESGO",
        value:  ""
      },
      {
        name: "SCORE",
        value: ""
      },
      {
        name: "ID",
        value: correlationId
      }
      ]
  }]]></ee:set-payload>
			</ee:message>
		</ee:transform>
			</otherwise>
		</choice>
		<flow-ref doc:name="registerLog-client" doc:id="476e8d6d-2db6-422f-9aa4-99f686357a63" name="registerLog-client" />
	</sub-flow>
</mule>
