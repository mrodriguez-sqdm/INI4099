<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="post-mediafonSendMsg-orchestratorSub_Flow" doc:id="d9f91abc-faa1-4aef-acfa-72cd38c511d7" >
		<ee:transform doc:name="Json to XML" doc:id="23339af4-5f4c-4833-9368-0ead02b48f73">
			<ee:message>
				<ee:set-payload><![CDATA[output application/java
import replaceAll from dw::core::Strings
---
replaceAll(replaceAll(replaceAll(write(payload.body, "application/xml", { "writeDeclaration": false }), "<", "&lt;"), ">", "&gt;"), "\n", "")]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<parse-template doc:name="Structure body for mediafon" doc:id="17e8c04f-537e-4bb0-952b-c1850af2b63d" location="soap\schemas\templates\mediafon-request.xml"/>
<!-- [STUDIO:"Structure body for mediafon1"]		<parse-template doc:name="Structure body for mediafon1" doc:id="ded70025-0b5c-4599-85df-ba3b0f6f5b4b" location="soap\schemas\templates\inetum-request.xml" /> [STUDIO] -->
		<ee:transform doc:name="Multipart message" doc:id="85bc6a2b-41e1-4b2d-baf5-d01c15b69392">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output multipart/related boundary="_Part_1484_1205094613.1721658606582"
import * from dw::module::Multipart
---
{
  parts: {
    root: field({name: "receiveMessage", value: payload, mime: "text/xml"}),
    "<sender>": field({name:"sender", value: "00007", mime: "text/plain"}),
    "<receiver>": field({name:"receiver", value: "00000", mime: "text/plain"}),
    "<typeMsg>": field({name:"typeMsg", value: vars.inputBody.MensajeABD.CabeceraMensaje.TipoMsg, mime: "text/plain"})
  } ++ if (!isEmpty(vars.attachments)) (vars.attachments.parts mapObject ((value, key, index) -> {
      "<$key>": {
            headers: {
                "Content-Disposition": {
                    name: "$key",
                    subtype: "form-data"
                },
                "Content-Type": "application/pdf",     "content-transfer-encoding": "base64"
            },
            content: value.content
        }
  })) else {}
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<flow-ref doc:name="Go to client" doc:id="13c844cd-b636-4b78-af77-b5c57ab24b17" name="post-mediafonSendMsg-clientSub_Flow"/>
		<ee:transform doc:name="Xml to Json" doc:id="63b54c87-8870-477a-972c-234fa88b8503" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload.Envelope.Body]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>
</mule>
