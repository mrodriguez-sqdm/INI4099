<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="post-consultaCupoNegLISIM-orchestratorSub_Flow" doc:id="a7cf1633-6040-45e6-9112-876c2db6f129" >
		<ee:transform doc:name="Transform Message" doc:id="8e4e67e8-6724-41ba-adfa-7ce419488f2d" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output text/xml 
ns soapenv http://schemas.xmlsoap.org/soap/envelope/
ns tem http://tempuri.org/
---
{
    soapenv#Envelope: {
        soapenv#Header:{},
        soapenv#Body: {
            tem#CalculoCupo: {
                tem#autenticacion: {
                    tem#Usuario: p('consultaCupoNegLISIM.properties.user'),
                    tem#Clave: p('consultaCupoNegLISIM.properties.password')
                },
                tem#objCalculo: {
                    tem#IdSolicitud: payload.quoteCalculation.calculationObject.requestId,
                    tem#InfBasicaEmpresa: {
                        (tem#RazonSocial: payload.quoteCalculation.calculationObject.companyBasicInformation.businessName) if (payload.quoteCalculation.calculationObject.companyBasicInformation.businessName != null),
                        (tem#TipoIdentificacion: payload.quoteCalculation.calculationObject.companyBasicInformation.identificationType) if (payload.quoteCalculation.calculationObject.companyBasicInformation.identificationType != null),
                        (tem#Identificacion: payload.quoteCalculation.calculationObject.companyBasicInformation.identification) if (payload.quoteCalculation.calculationObject.companyBasicInformation.identification != null),
                        (tem#Ciudad: payload.quoteCalculation.calculationObject.companyBasicInformation.city) if (payload.quoteCalculation.calculationObject.companyBasicInformation.city != null),
                        (tem#Direccion: payload.quoteCalculation.calculationObject.companyBasicInformation.address) if (payload.quoteCalculation.calculationObject.companyBasicInformation.address != null)
                    },
                    tem#InfAdicionalEmpresa: {
                        (tem#ActividadEconomica: payload.quoteCalculation.calculationObject.companyAdditionalInformation.economicActivity) if (payload.quoteCalculation.calculationObject.companyAdditionalInformation.economicActivity != null),
                        (tem#FechaConstitucion: payload.quoteCalculation.calculationObject.companyAdditionalInformation.constitutionDate) if (payload.quoteCalculation.calculationObject.companyAdditionalInformation.constitutionDate != null),
                        (tem#Estrato: payload.quoteCalculation.calculationObject.companyAdditionalInformation.stratum) if (payload.quoteCalculation.calculationObject.companyAdditionalInformation.stratum != null),
                        (tem#IdZona: payload.quoteCalculation.calculationObject.companyAdditionalInformation.zoneId) if (payload.quoteCalculation.calculationObject.companyAdditionalInformation.zoneId != null)
                    },
                    tem#RepresentanteLegal: {
                        (tem#Nombres: payload.quoteCalculation.calculationObject.legalRepresentative.names) if (payload.quoteCalculation.calculationObject.legalRepresentative.names != null),
                        (tem#Apellidos: payload.quoteCalculation.calculationObject.legalRepresentative.surnames) if (payload.quoteCalculation.calculationObject.legalRepresentative.surnames != null),
                        (tem#TipoIdentificacion: payload.quoteCalculation.calculationObject.legalRepresentative.identificationType) if (payload.quoteCalculation.calculationObject.legalRepresentative.identificationType != null),
                        (tem#Identificacion: payload.quoteCalculation.calculationObject.legalRepresentative.identification) if (payload.quoteCalculation.calculationObject.legalRepresentative.identification != null),
                        (tem#FechaNacimiento: payload.quoteCalculation.calculationObject.legalRepresentative.dateBirth) if (payload.quoteCalculation.calculationObject.legalRepresentative.dateBirth != null)
                    },
                    tem#BalanceGeneral: {
                        (tem#TotalActivoCorriente: payload.quoteCalculation.calculationObject.generalBalance.totalCurrentAssets) if (payload.quoteCalculation.calculationObject.generalBalance.totalCurrentAssets != null),
                        (tem#Inventarios: payload.quoteCalculation.calculationObject.generalBalance.inventories) if (payload.quoteCalculation.calculationObject.generalBalance.inventories != null),
                        (tem#TotalActivos: payload.quoteCalculation.calculationObject.generalBalance.totalAssets) if (payload.quoteCalculation.calculationObject.generalBalance.totalAssets != null),
                        (tem#TotalPasivoCorriente: payload.quoteCalculation.calculationObject.generalBalance.totalCurrentLiabilities) if (payload.quoteCalculation.calculationObject.generalBalance.totalCurrentLiabilities != null),
                        (tem#TotalPasivo: payload.quoteCalculation.calculationObject.generalBalance.totalLiabilities) if (payload.quoteCalculation.calculationObject.generalBalance.totalLiabilities != null),
                        (tem#TotalPatrimonio: payload.quoteCalculation.calculationObject.generalBalance.totalPatrimony) if (payload.quoteCalculation.calculationObject.generalBalance.totalPatrimony != null)
                    },
                    tem#EstadoResultados: {
                        (tem#IngresosOperacionalesAnioCorriente: payload.quoteCalculation.calculationObject.statusResults.currentYearOperatingRevenue) if (payload.quoteCalculation.calculationObject.statusResults.currentYearOperatingRevenue != null),
                        (tem#IngresosNoOperacionalesAnioCorriente: payload.quoteCalculation.calculationObject.statusResults.currentYearNoOperatingRevenue) if (payload.quoteCalculation.calculationObject.statusResults.currentYearNoOperatingRevenue != null),
                        (tem#IngresosOperacionalesAnioAnterior: payload.quoteCalculation.calculationObject.statusResults.previousYearOperatingRevenue) if (payload.quoteCalculation.calculationObject.statusResults.previousYearOperatingRevenue != null),
                        (tem#IngresosNoOperacionalesAnioAnterior: payload.quoteCalculation.calculationObject.statusResults.previousYearNoOperatingRevenue) if (payload.quoteCalculation.calculationObject.statusResults.previousYearNoOperatingRevenue != null),
                        (tem#CostoVenta: payload.quoteCalculation.calculationObject.statusResults.costSale) if (payload.quoteCalculation.calculationObject.statusResults.costSale != null),
                        (tem#GastosOperacionales: payload.quoteCalculation.calculationObject.statusResults.operationalExpenses) if (payload.quoteCalculation.calculationObject.statusResults.operationalExpenses != null),
                        (tem#UtilidadesOperacionales: payload.quoteCalculation.calculationObject.statusResults.operationalProfit) if (payload.quoteCalculation.calculationObject.statusResults.operationalProfit != null),
                        (tem#OtrosEgresos: payload.quoteCalculation.calculationObject.statusResults.otherExpenses) if (payload.quoteCalculation.calculationObject.statusResults.otherExpenses != null),
                        (tem#UtilidadNeta: payload.quoteCalculation.calculationObject.statusResults.netProfit) if (payload.quoteCalculation.calculationObject.statusResults.netProfit != null),
                        (tem#UtilidadAntesDeImpuestos: payload.quoteCalculation.calculationObject.statusResults.beforeTaxProfit) if (payload.quoteCalculation.calculationObject.statusResults.beforeTaxProfit != null),
                        (tem#ImpuestosRentaYComplementarios: payload.quoteCalculation.calculationObject.statusResults.incomeTaxAndComplementary) if (payload.quoteCalculation.calculationObject.statusResults.incomeTaxAndComplementary != null),
                        (tem#CuentasPorCobrar: payload.quoteCalculation.calculationObject.statusResults.accountReceivable) if (payload.quoteCalculation.calculationObject.statusResults.accountReceivable != null),
                        (tem#ObligacionesFinancieras: payload.quoteCalculation.calculationObject.statusResults.financialObligations) if (payload.quoteCalculation.calculationObject.statusResults.financialObligations != null)
                    },
                    tem#Politica: {
                        tem#Descripcion: ""
                    }
                }
            }
        }
    }
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<flow-ref doc:name="Call to etbpyme" doc:id="1deeb4ab-a28c-4085-823b-f97cc5f786ed" name="etbpyme-Sub_Flow"/>
		<ee:transform doc:name="Response 200" doc:id="d293c89f-01c0-498d-9c9c-b2bb5cfaf0a0">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
import replaceAll from dw::core::Strings
---

{
    "quotaCalculationResponse": { 
        "quotaCalculationResult": {
            "requestId": payload.Envelope.Body.CalculoCupoResponse.CalculoCupoResult.IdSolicitud as Number,
            "controlDate": payload.Envelope.Body.CalculoCupoResponse.CalculoCupoResult.FechaControl as String,
            "businessName": replaceAll(payload.Envelope.Body.CalculoCupoResponse.CalculoCupoResult.RazonSocial,"\"",""),
            "nit": replaceAll(payload.Envelope.Body.CalculoCupoResponse.CalculoCupoResult.Nit,"\"",""),
            "approvedQuota": payload.Envelope.Body.CalculoCupoResponse.CalculoCupoResult.CupoAprobado as Number,
            "score": payload.Envelope.Body.CalculoCupoResponse.CalculoCupoResult.Score as Number,
            "riskLevel": payload.Envelope.Body.CalculoCupoResponse.CalculoCupoResult.NivelRiesgo,
            "errorId": payload.Envelope.Body.CalculoCupoResponse.CalculoCupoResult.IdError as Number,
            "errorMessage": if(payload.Envelope.Body.CalculoCupoResponse.CalculoCupoResult.MensajeError == null) "" else payload.Envelope.Body.CalculoCupoResponse.CalculoCupoResult.MensajeError as String
        }
    }
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>
</mule>
