<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="geographicAddressComplementResolver-orchestratorSub_Flow" doc:id="a2b87066-d619-4cc7-bd32-a936953f10fe" >
		<flow-ref doc:name="Go to client" doc:id="1e632f84-dff7-409b-9828-7b5bd06f6cc4" name="get-geographicAddress-operation-clientSub_Flow"/>
	</sub-flow>
	<sub-flow name="coverage-orchestratorSub_Flow" doc:id="e1fca17b-23c8-49ad-a8f5-c7947418d220" >
		<flow-ref doc:name="get-coverage-clientSub_Flow" doc:id="bf99ba4c-51bd-4296-a506-c83fe62e7bcc" name="get-coverage-clientSub_Flow" />
	</sub-flow>
	<sub-flow name="geocodificar-orchestratorSub_Flow" doc:id="geocodificar-orchestrator-subflow" >
		<flow-ref doc:name="get-geocodificar-clientSub_Flow" doc:id="geocodificar-client-ref" name="get-geocodificar-clientSub_Flow"/>
	</sub-flow>
	<sub-flow name="georeference-orchestratorSub_Flow" doc:id="georeference-orchestrator-subflow" >
		<!-- ✅ API-LED: XAPI llama a PAPI, no directo a SAPI -->
		<flow-ref doc:name="get-georeference via common-papi" doc:id="georeference-client-ref" name="get-georeference-common-papi-clientSub_Flow"/>
	</sub-flow>
	<sub-flow name="normalize-address-orchestratorSub_Flow" doc:id="normalize-address-orchestrator-subflow" >
		<!-- Guardar queryParams completo - solución escalable y clean -->
		<set-variable value="#[attributes.queryParams]" doc:name="queryParams" doc:id="save-query-params" variableName="queryParams" />
		
		<!-- Decisión de negocio: CATASTRO vs SISEXT -->
		<choice doc:name="Choice normalizador" doc:id="orch-choice-normalizador" >
			<when expression='#[vars.queryParams.municipalityCod == "11001" and (p("normalizador.tipo") default "CATASTRO") == "CATASTRO"]'>
				<!-- Flujo CATASTRO con fallback a SISEXT -->
				<try doc:name="Try Catastro" doc:id="orch-try-catastro">
					<flow-ref doc:name="geocodificar-orchestratorSub_Flow" doc:id="orch-catastro-ref" name="geocodificar-orchestratorSub_Flow" />
					<error-handler>
						<on-error-continue enableNotifications="true" logException="true" doc:name="Fallback to SISEXT" doc:id="orch-catastro-error" type="HTTP:TIMEOUT, HTTP:NOT_FOUND, HTTP:BAD_REQUEST, HTTP:UNAUTHORIZED, HTTP:FORBIDDEN, HTTP:INTERNAL_SERVER_ERROR, HTTP:SERVICE_UNAVAILABLE, HTTP:BAD_GATEWAY">
							<choice doc:name="Fallback enabled?" doc:id="orch-choice-fallback">
								<when expression="#[(p('normalizador.fallback') default true) == true]">
									<flow-ref doc:name="georeference-orchestratorSub_Flow" doc:id="orch-fallback-ref" name="georeference-orchestratorSub_Flow" />
									<ee:transform doc:name="Transform SISEXT to Catastro format" doc:id="orch-transform-sisext">
										<ee:message>
											<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	response: {
		success: payload.outputMessage != null,
		data: if (payload.outputMessage != null) {
			estado: "success",
			yinput: payload.outputMessage."WSGeorreferenciarCR-RS".Latitud default "",
			lotcodigo: payload.outputMessage."WSGeorreferenciarCR-RS".CodigoLote default "unknown",
			latitude: payload.outputMessage."WSGeorreferenciarCR-RS".Latitud default "",
			diraprox: payload.outputMessage."WSGeorreferenciarCR-RS".DireccionNormalizada default vars.queryParams.address,
			mancodigo: "",
			cpocodigo: vars.queryParams.municipalityCod default "",
			xinput: payload.outputMessage."WSGeorreferenciarCR-RS".Longitud default "",
			codloc: payload.outputMessage."WSGeorreferenciarCR-RS".Localidad default "",
			dirtrad: payload.outputMessage."WSGeorreferenciarCR-RS".DireccionNormalizada default vars.queryParams.address,
			nomupz: "",
			localidad: payload.outputMessage."WSGeorreferenciarCR-RS".Localidad default "",
			dirinput: vars.queryParams.address default "",
			codupz: "",
			nomseccat: "",
			tipo_direccion: "Normalizada por SISEXT (Fallback)",
			codseccat: "",
			longitude: payload.outputMessage."WSGeorreferenciarCR-RS".Longitud default ""
		} else {
			estado: "error",
			dirinput: vars.queryParams.address default "",
			tipo_direccion: "No encontrada",
			message: payload.outPutMessage.message default "Dirección no encontrada"
		},
		message: if (payload.outputMessage != null) 
			"Geocodificación Exitosa via SISEXT (Fallback)"
		else
			payload.outPutMessage.message default "Dirección no encontrada"
	},
	status: payload.outputMessage != null
}]]></ee:set-payload>
										</ee:message>
									</ee:transform>
								</when>
								<otherwise>
									<raise-error type="CATASTRO:API_ERROR" doc:name="Raise Error" doc:id="orch-raise-error" description="#['Catastro API failed: ' ++ error.description]" />
								</otherwise>
							</choice>
						</on-error-continue>
					</error-handler>
				</try>
				<!-- Transform a TMF673 para CATASTRO -->
				<ee:transform doc:name="Transform to TMF673 format" doc:id="orch-transform-tmf673-catastro">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
[{
	Success: payload.response.success default false,
	DataList: null,
	DataArray: null,
	DataSingle: {
		Addresses: [
			{
				id: payload.response.data.lotcodigo default "unknown",
				fullAddress: payload.response.data.dirinput default "",
				Direccion_Actual: payload.response.data.dirtrad default payload.response.data.diraprox default "",
				residentialType: payload.response.data.codloc default "",
				municipalityCode: vars.queryParams.municipalityCod default "",
				latitude: payload.response.data.latitude default "",
				longitude: payload.response.data.longitude default "",
				diraprox: payload.response.data.diraprox default "",
				tipo_direccion: payload.response.data.tipo_direccion default "",
				Check: false
			}
		]
	},
	Message: payload.response.message default "",
	Results: 1,
	MessageObj: null
}]]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</when>
			<otherwise >
				<!-- Flujo SISEXT para no-Bogotá o cuando vNormalizador=SISEXT -->
				<flow-ref doc:name="georeference-orchestratorSub_Flow" doc:id="orch-sisext-ref" name="georeference-orchestratorSub_Flow" />
				<!-- Transform a TMF673 para SISEXT -->
				<ee:transform doc:name="Transform SISEXT to TMF673" doc:id="orch-transform-tmf673-sisext">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
[{
	Success: payload.outputMessage != null,
	DataList: null,
	DataArray: null,
	DataSingle: {
		Addresses: if (payload.outputMessage != null) [
			{
				id: payload.outputMessage."WSGeorreferenciarCR-RS".CodigoDireccion default "unknown",
				fullAddress: payload.outputMessage."WSGeorreferenciarCR-RS".DireccionNormalizada default vars.queryParams.address,
				Direccion_Actual: payload.outputMessage."WSGeorreferenciarCR-RS".DireccionNormalizada default vars.queryParams.address,
				residentialType: payload.outputMessage."WSGeorreferenciarCR-RS".Destino default "",
				municipalityCode: vars.queryParams.municipalityCod default "",
				latitude: payload.outputMessage."WSGeorreferenciarCR-RS".Latitud default "",
				longitude: payload.outputMessage."WSGeorreferenciarCR-RS".Longitud default "",
				diraprox: payload.outputMessage."WSGeorreferenciarCR-RS".DireccionNormalizada default vars.queryParams.address,
				tipo_direccion: "Normalizada por SISEXT",
				Check: false
			}
		] else []
	},
	Message: if (payload.outputMessage != null) 
		"Georeferenciación exitosa por SISEXT"
	else
		payload.outPutMessage.message default "Dirección no encontrada",
	Results: if (payload.outputMessage != null) 1 else 0,
	MessageObj: null
}]]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</otherwise>
		</choice>
	</sub-flow>
</mule>
