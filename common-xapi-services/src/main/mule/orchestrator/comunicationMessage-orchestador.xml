<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="post-comunicationMessage-orchestadorSub_Flow" doc:id="b6d7b858-024a-47e6-b623-78f3fab11db0" >
		<set-variable value="#[attributes.queryParams]" doc:name="Save Parameters" doc:id="d36caced-3d3a-4f50-a568-6310d16883fe" variableName="parameters" />
		<set-variable value="#[attributes.headers]" doc:name="Save headers" doc:id="d4f9b24c-d5f7-4b33-a9b5-4147ab142208" variableName="headers" />
		<ee:transform doc:name="Transform Message Bot Request" doc:id="19fd883e-c498-4f16-9927-056000fcdb36" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  WSRequestHeader: {
    System: {
      name: vars.headers.name,
      correlationID: vars.headers."X-CORRELATION-ID",
      processingServer: ""
    },
    Property: []
  },
  WSRequestBody: {
    Audit: {
      Canal: vars.headers.name
    },
    Address: payload.customer.address default "",
    Contact_Phone: payload.customer.phone default "",
    Document_Number: payload.customer.documentNumber default "",
    Document_Type: payload.customer.documentType default "",
    Email: payload.notification.email default "",
    Expedition_Date: payload.customer.documentIssueDate default "",
    Kind_Procedure: payload.notificationType default "",
    Number_PQR: payload.notification.pqr default "",
    Phone: payload.notification.phoneNotification default ""
  }

}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<flow-ref doc:name="Flow Reference" doc:id="40458641-6d63-4ad4-a2d9-dc37d57dacfe" name="sendnotify-bot-sapi-2-clientSub_Flow" />
		<set-variable value='#[if(payload.WSResponseHeader.Service.status == "FAIL" and payload.WSResponseHeader.Service.statusDetail[0].errorCode == "BOTERROR")&#10; 500&#10;else&#10; 200]' doc:name="Set Variable" doc:id="b2a566c8-ffa1-4a0f-a584-a19b84359365" variableName="httpStatus" />
		<ee:transform doc:name="Transform Bot Response" doc:id="692c49a6-87cb-4ecb-a15f-126ae28e8c2d" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  codeResponse: vars.httpStatus as String,
  messageResponse: payload.WSResponseHeader.Service.StatusDetail[0].ErrorMessage,
  detail: {
    message: payload.WSResponseHeader.Service.StatusDetail[0].ErrorMessageUser
  }
  
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>
</mule>
